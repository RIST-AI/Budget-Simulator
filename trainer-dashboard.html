<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="description" content="Trainer Dashboard for AHCBUS408 Budget Master - Manage student assessments and budgets">
    <title>Trainer Dashboard - AHCBUS408 Budget Master</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="images/RIST Brandmark - Navy Circle.png" type="image/png">
    <style>
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .dashboard-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .dashboard-card h3 {
            margin-top: 0;
            border-bottom: 1px solid #e1e4e8;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .dashboard-card h3 .count-badge {
            background-color: var(--primary-orange);
            color: white;
            font-size: 0.8em;
            padding: 3px 8px;
            border-radius: 12px;
        }
        
        .assessment-list, .budget-list, .student-list {
            list-style: none;
            padding: 0;
        }
        
        .assessment-list li, .budget-list li, .student-list li {
            padding: 10px;
            border-bottom: 1px solid #e1e4e8;
        }
        
        .assessment-list li:last-child, .budget-list li:last-child, .student-list li:last-child {
            border-bottom: none;
        }
        
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-submitted {
            background-color: #e1f5fe;
            color: #0288d1;
        }
        
        .status-graded {
            background-color: #e8f5e9;
            color: #388e3c;
        }
        
        .status-feedback {
            background-color: #fff8e1;
            color: #ff8f00;
        }
        
        .empty-state {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        
        .user-info {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .tab-buttons {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #e1e4e8;
            overflow-x: auto;
            white-space: nowrap;
            padding-bottom: 5px;
        }
        
        .tab-button {
            padding: 10px 20px;
            background-color: #f8f9fa;
            border: none;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
            cursor: pointer;
        }
        
        .tab-button.active {
            background-color: var(--primary-orange);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .search-bar {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        
        .search-bar input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .btn-view {
            background-color: #3498db;
            color: white;
        }
        
        .btn-grade {
            background-color: #2ecc71;
            color: white;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .data-table th, .data-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e1e4e8;
        }
        
        .data-table th {
            background-color: #f1f1f1;
            font-weight: bold;
        }
        
        .data-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .dashboard-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .summary-card .number {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--primary-navy);
            margin: 10px 0;
        }
        
        .summary-card .label {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        .filter-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .filter-option {
            padding: 5px 10px;
            background-color: #f8f9fa;
            border: 1px solid #e1e4e8;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .filter-option.active {
            background-color: var(--primary-orange);
            color: white;
            border-color: var(--primary-orange);
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 5px;
        }
        
        .pagination-button {
            padding: 5px 10px;
            background-color: #f8f9fa;
            border: 1px solid #e1e4e8;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .pagination-button.active {
            background-color: var(--primary-orange);
            color: white;
            border-color: var(--primary-orange);
        }
        
        .pagination-button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        @media (max-width: 768px) {
            .dashboard-summary {
                grid-template-columns: 1fr 1fr;
            }
            
            .data-table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo-container">
                    <img src="images/RIST - Primary Colour.jpg" alt="RIST - Rural Industries Skill Training" class="rist-logo">
                </div>
                <div class="title-container">
                    <h1>AHCBUS408 Budget Master</h1>
                    <p>Agricultural Budgeting Training Tool</p>
                </div>
                <div id="user-status" class="user-status">
                    <!-- Login status will be shown here -->
                </div>
            </div>
        </div>
    </header>
    <nav>
        <div class="container">
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="budget.html">Budget Simulator</a></li>
                <li><a href="farm-budget-assessment.html">Assessment</a></li>
                <li><a href="trainer-dashboard.html" class="active">Dashboard</a></li>
                <li id="logout-nav-item"><a href="#" id="logout-link">Logout</a></li>
            </ul>
        </div>
    </nav>

    <main class="container">
        <h2>Trainer Dashboard</h2>
        
        <div id="user-info" class="user-info">
            <p><strong>Loading user information...</strong></p>
        </div>
        
        <div class="dashboard-summary">
            <div class="summary-card">
                <div class="label">Total Students</div>
                <div class="number" id="total-students">0</div>
            </div>
            <div class="summary-card">
                <div class="label">Pending Assessments</div>
                <div class="number" id="pending-assessments">0</div>
            </div>
            <div class="summary-card">
                <div class="label">Graded Assessments</div>
                <div class="number" id="graded-assessments">0</div>
            </div>
            <div class="summary-card">
                <div class="label">Average Grade</div>
                <div class="number" id="average-grade">0</div>
            </div>
        </div>
        
        <div class="tab-buttons">
            <button class="tab-button active" data-tab="assessments">Student Assessments</button>
            <button class="tab-button" data-tab="budgets">Student Budgets</button>
            <button class="tab-button" data-tab="students">Students</button>
        </div>
        
        <div id="assessments" class="tab-content active">
            <div class="search-bar">
                <input type="text" id="assessment-search" placeholder="Search by student name or ID...">
            </div>
            
            <div class="filter-options">
                <div class="filter-option active" data-filter="all">All</div>
                <div class="filter-option" data-filter="submitted">Pending Review</div>
                <div class="filter-option" data-filter="graded">Graded</div>
                <div class="filter-option" data-filter="recent">Recent (7 days)</div>
            </div>
            
            <div class="dashboard-card">
                <h3>Student Assessments <span class="count-badge" id="assessment-count">0</span></h3>
                <div id="assessments-container">
                    <p class="loading">Loading assessments...</p>
                </div>
                
                <div class="pagination" id="assessments-pagination">
                    <!-- Pagination will be added here -->
                </div>
            </div>
        </div>
        
        <div id="budgets" class="tab-content">
            <div class="search-bar">
                <input type="text" id="budget-search" placeholder="Search by student name or budget name...">
            </div>
            
            <div class="filter-options">
                <div class="filter-option active" data-filter="all">All</div>
                <div class="filter-option" data-filter="recent">Recent (7 days)</div>
            </div>
            
            <div class="dashboard-card">
                <h3>Student Budgets <span class="count-badge" id="budget-count">0</span></h3>
                <div id="budgets-container">
                    <p class="loading">Loading budgets...</p>
                </div>
                
                <div class="pagination" id="budgets-pagination">
                    <!-- Pagination will be added here -->
                </div>
            </div>
        </div>
        
        <div id="students" class="tab-content">
            <div class="search-bar">
                <input type="text" id="student-search" placeholder="Search by name or email...">
            </div>
            
            <div class="filter-options">
                <div class="filter-option active" data-filter="all">All</div>
                <div class="filter-option" data-filter="active">Active</div>
                <div class="filter-option" data-filter="recent">Recent (7 days)</div>
            </div>
            
            <div class="dashboard-card">
                <h3>Students <span class="count-badge" id="student-count">0</span></h3>
                <div id="students-container">
                    <p class="loading">Loading students...</p>
                </div>
                
                <div class="pagination" id="students-pagination">
                    <!-- Pagination will be added here -->
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <img src="images/RIST Brandmark - Navy Circle.png" alt="RIST" class="rist-logo-footer">
                </div>
                <div class="footer-info">
                    <p>&copy; 2025 RIST - Rural Industries Skill Training</p>
                    <p>AHCBUS408 Budget Master</p>
                </div>
                <div class="footer-contact">
                    <p>Contact: <a href="mailto:info@rist.com.au">info@rist.com.au</a></p>
                </div>
            </div>
        </div>
    </footer>

    <script type="module">
        import { auth, onAuthStateChanged, signOut, db, doc, getDoc, collection, query, where, getDocs, orderBy, limit, startAfter } from './js/firebase-config.js';
        
        // Check authentication first using localStorage
        const storedUser = localStorage.getItem('currentUser');
        if (storedUser) {
            const user = JSON.parse(storedUser);
            document.getElementById('user-status').innerHTML = 'Logged in as: ' + user.email;
            
            // Check role for appropriate access
            const storedRole = localStorage.getItem('userRole');
            if (storedRole !== 'trainer') {
                // Redirect students to student dashboard
                window.location.href = 'student-dashboard.html';
            } else {
                // Initialize the trainer dashboard
                initializeDashboard(user);
            }
        } else {
            // If no stored user, check Firebase auth
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    document.getElementById('user-status').innerHTML = 'Logged in as: ' + user.email;
                    
                    // Store user in localStorage for persistence
                    localStorage.setItem('currentUser', JSON.stringify({
                        uid: user.uid,
                        email: user.email
                    }));
                    
                    // Check user role
                    getDoc(doc(db, 'users', user.uid)).then(userDoc => {
                        if (userDoc.exists()) {
                            const role = userDoc.data().role;
                            localStorage.setItem('userRole', role);
                            
                            // Check for appropriate access
                            if (role !== 'trainer') {
                                // Redirect students to student dashboard
                                window.location.href = 'student-dashboard.html';
                            } else {
                                // Initialize the trainer dashboard
                                initializeDashboard(user);
                            }
                        }
                    }).catch(error => {
                        console.error("Error checking user role:", error);
                    });
                } else {
                    // Not authenticated, redirect to login
                    window.location.href = 'login.html';
                }
            });
        }
        
        // Logout functionality
        document.getElementById('logout-link').addEventListener('click', function(e) {
            e.preventDefault();
            
            // Clear localStorage
            localStorage.removeItem('currentUser');
            localStorage.removeItem('userRole');
            
            // Also sign out from Firebase
            signOut(auth).then(() => {
                // Sign-out successful
                window.location.href = 'login.html';
            }).catch((error) => {
                // An error happened
                console.error("Error signing out:", error);
                // Still redirect to login
                window.location.href = 'login.html';
            });
        });
        
        // Global variables for pagination
        const ITEMS_PER_PAGE = 10;
        let lastAssessmentDoc = null;
        let lastBudgetDoc = null;
        let lastStudentDoc = null;
        let currentAssessmentsPage = 1;
        let currentBudgetsPage = 1;
        let currentStudentsPage = 1;
        let totalAssessmentPages = 1;
        let totalBudgetPages = 1;
        let totalStudentPages = 1;
        let currentAssessmentsFilter = 'all';
        let currentBudgetsFilter = 'all';
        let currentStudentsFilter = 'all';
        
        // Initialize dashboard function
        function initializeDashboard(user) {
            // Load user info
            loadUserInfo(user.uid);
            
            // Load dashboard summary
            loadDashboardSummary();
            
            // Load data for all tabs
            loadAllAssessments();
            loadAllBudgets();
            loadAllStudents();
            
            // Set up tab switching
            setupTabs();
            
            // Set up search functionality
            setupSearch();
            
            // Set up filters
            setupFilters();
        }
        
        // Load user information
        async function loadUserInfo(userId) {
            try {
                const userDoc = await getDoc(doc(db, 'users', userId));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    
                    document.getElementById('user-info').innerHTML = `
                        <p><strong>Name:</strong> ${userData.fullName || 'Not provided'}</p>
                        <p><strong>Email:</strong> ${userData.email}</p>
                        <p><strong>Role:</strong> Trainer</p>
                    `;
                }
            } catch (error) {
                console.error("Error loading user info:", error);
                document.getElementById('user-info').innerHTML = `
                    <p class="error">Error loading user information: ${error.message}</p>
                `;
            }
        }
        
        // Load dashboard summary
        async function loadDashboardSummary() {
            try {
                // Count total students
                const studentsQuery = query(collection(db, "users"), where("role", "==", "student"));
                const studentsSnapshot = await getDocs(studentsQuery);
                const totalStudents = studentsSnapshot.size;
                
                // Count assessments
                const assessmentsSnapshot = await getDocs(collection(db, "assessments"));
                const allAssessments = assessmentsSnapshot.docs.map(doc => doc.data());
                
                const pendingAssessments = allAssessments.filter(assessment => 
                    assessment.status !== 'graded').length;
                
                const gradedAssessments = allAssessments.filter(assessment => 
                    assessment.status === 'graded').length;
                
                // Calculate average grade
                let totalGrades = 0;
                let gradeCount = 0;
                
                allAssessments.forEach(assessment => {
                    if (assessment.grade) {
                        totalGrades += assessment.grade;
                        gradeCount++;
                    }
                });
                
                const averageGrade = gradeCount > 0 ? Math.round(totalGrades / gradeCount) : 0;
                
                // Update the summary cards
                document.getElementById('total-students').textContent = totalStudents;
                document.getElementById('pending-assessments').textContent = pendingAssessments;
                document.getElementById('graded-assessments').textContent = gradedAssessments;
                document.getElementById('average-grade').textContent = averageGrade;
                
            } catch (error) {
                console.error("Error loading dashboard summary:", error);
            }
        }
        
        // Load all assessments
        async function loadAllAssessments(filterType = 'all', searchTerm = '', page = 1) {
            try {
                const assessmentsContainer = document.getElementById('assessments-container');
                assessmentsContainer.innerHTML = '<p class="loading">Loading assessments...</p>';
                
                // Build query based on filter
                let q;
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                
                switch (filterType) {
                    case 'submitted':
                        q = query(
                            collection(db, "assessments"), 
                            where("status", "!=", "graded"),
                            orderBy("status"),
                            orderBy("submittedAt", "desc")
                        );
                        break;
                    case 'graded':
                        q = query(
                            collection(db, "assessments"), 
                            where("status", "==", "graded"),
                            orderBy("submittedAt", "desc")
                        );
                        break;
                    case 'recent':
                        q = query(
                            collection(db, "assessments"), 
                            where("submittedAt", ">=", sevenDaysAgo),
                            orderBy("submittedAt", "desc")
                        );
                        break;
                    default:
                        q = query(
                            collection(db, "assessments"), 
                            orderBy("submittedAt", "desc")
                        );
                }
                
                // Get total count for pagination
                const countSnapshot = await getDocs(q);
                const totalAssessments = countSnapshot.size;
                document.getElementById('assessment-count').textContent = totalAssessments;
                totalAssessmentPages = Math.ceil(totalAssessments / ITEMS_PER_PAGE);
                
                // Apply pagination
                if (page === 1) {
                    q = query(q, limit(ITEMS_PER_PAGE));
                    lastAssessmentDoc = null;
                } else if (lastAssessmentDoc) {
                    q = query(q, startAfter(lastAssessmentDoc), limit(ITEMS_PER_PAGE));
                }
                
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    assessmentsContainer.innerHTML = `
                        <div class="empty-state">
                            <p>No assessments found matching your criteria.</p>
                        </div>
                    `;
                    return;
                }
                
                // Save the last document for pagination
                lastAssessmentDoc = querySnapshot.docs[querySnapshot.docs.length - 1];
                
                // Create table of assessments
                let assessmentsTable = `
                    <table class="data-table" id="assessments-table">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Student ID</th>
                                <th>Unit Code</th>
                                <th>Submitted Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                querySnapshot.forEach((doc) => {
                    const assessment = doc.data();
                    const submittedDate = assessment.submittedAt ? 
                        new Date(assessment.submittedAt.seconds * 1000).toLocaleDateString() : 
                        'Unknown';
                    
                    // Apply search filter if provided
                    if (searchTerm && !(
                        (assessment.studentName && assessment.studentName.toLowerCase().includes(searchTerm.toLowerCase())) ||
                        (assessment.studentId && assessment.studentId.toLowerCase().includes(searchTerm.toLowerCase()))
                    )) {
                        return; // Skip this item if it doesn't match search
                    }
                    
                    assessmentsTable += `
                        <tr data-id="${doc.id}">
                            <td>${assessment.studentName || 'Unknown'}</td>
                            <td>${assessment.studentId || 'Unknown'}</td>
                            <td>${assessment.unitCode || 'Unknown'}</td>
                            <td>${submittedDate}</td>
                            <td>
                                <span class="status-badge status-${assessment.status || 'submitted'}">
                                    ${assessment.status ? assessment.status.charAt(0).toUpperCase() + assessment.status.slice(1) : 'Submitted'}
                                </span>
                            </td>
                            <td class="action-buttons">
                                <button class="btn-small btn-view" onclick="window.location.href='view-assessment.html?id=${doc.id}'">View</button>
                                ${assessment.status !== 'graded' ? 
                                    `<button class="btn-small btn-grade" onclick="window.location.href='review-assessment.html?id=${doc.id}'">Review</button>` : 
                                    ''}
                            </td>
                        </tr>
                    `;
                });
                
                assessmentsTable += `
                        </tbody>
                    </table>
                `;
                
                assessmentsContainer.innerHTML = assessmentsTable;
                
                // Update pagination
                updatePagination('assessments', currentAssessmentsPage, totalAssessmentPages);
                
            } catch (error) {
                console.error("Error loading assessments:", error);
                document.getElementById('assessments-container').innerHTML = `
                    <p class="error">Error loading assessments: ${error.message}</p>
                `;
            }
        }
        
        // Load all budgets
        async function loadAllBudgets(filterType = 'all', searchTerm = '', page = 1) {
            try {
                const budgetsContainer = document.getElementById('budgets-container');
                budgetsContainer.innerHTML = '<p class="loading">Loading budgets...</p>';
                
                // Build query based on filter
                let q;
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                
                switch (filterType) {
                    case 'recent':
                        q = query(
                            collection(db, "budgets"), 
                            where("createdAt", ">=", sevenDaysAgo),
                            orderBy("createdAt", "desc")
                        );
                        break;
                    default:
                        q = query(
                            collection(db, "budgets"), 
                            orderBy("createdAt", "desc")
                        );
                }
                
                // Get total count for pagination
                const countSnapshot = await getDocs(q);
                const totalBudgets = countSnapshot.size;
                document.getElementById('budget-count').textContent = totalBudgets;
                totalBudgetPages = Math.ceil(totalBudgets / ITEMS_PER_PAGE);
                
                // Apply pagination
                if (page === 1) {
                    q = query(q, limit(ITEMS_PER_PAGE));
                    lastBudgetDoc = null;
                } else if (lastBudgetDoc) {
                    q = query(q, startAfter(lastBudgetDoc), limit(ITEMS_PER_PAGE));
                }
                
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    budgetsContainer.innerHTML = `
                        <div class="empty-state">
                            <p>No budgets have been created yet.</p>
                        </div>
                    `;
                    return;
                }
                
                // Save the last document for pagination
                lastBudgetDoc = querySnapshot.docs[querySnapshot.docs.length - 1];
                
                // Create table of budgets
                let budgetsTable = `
                    <table class="data-table" id="budgets-table">
                        <thead>
                            <tr>
                                <th>Budget Name</th>
                                <th>Student Email</th>
                                <th>Farm Type</th>
                                <th>Period</th>
                                <th>Created Date</th>
                                <th>Net Result</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                querySnapshot.forEach((doc) => {
                    const budget = doc.data();
                    const createdDate = budget.createdAt ? 
                        new Date(budget.createdAt.seconds * 1000).toLocaleDateString() : 
                        'Unknown';
                    
                    // Apply search filter if provided
                    if (searchTerm && !(
                        (budget.name && budget.name.toLowerCase().includes(searchTerm.toLowerCase())) ||
                        (budget.userEmail && budget.userEmail.toLowerCase().includes(searchTerm.toLowerCase()))
                    )) {
                        return; // Skip this item if it doesn't match search
                    }
                    
                    budgetsTable += `
                        <tr data-id="${doc.id}">
                            <td>${budget.name || 'Untitled Budget'}</td>
                            <td>${budget.userEmail || 'Unknown'}</td>
                            <td>${budget.farmType || 'Unknown'}</td>
                            <td>${budget.period || 'Unknown'}</td>
                            <td>${createdDate}</td>
                            <td>${formatCurrency(budget.netResult || 0)}</td>
                            <td class="action-buttons">
                                <button class="btn-small btn-view" onclick="viewBudget('${doc.id}')">View</button>
                            </td>
                        </tr>
                    `;
                });
                
                budgetsTable += `
                        </tbody>
                    </table>
                `;
                
                budgetsContainer.innerHTML = budgetsTable;
                
                // Update pagination
                updatePagination('budgets', currentBudgetsPage, totalBudgetPages);
                
            } catch (error) {
                console.error("Error loading budgets:", error);
                document.getElementById('budgets-container').innerHTML = `
                    <p class="error">Error loading budgets: ${error.message}</p>
                `;
            }
        }
        
        // Load all students
        async function loadAllStudents(filterType = 'all', searchTerm = '', page = 1) {
            try {
                const studentsContainer = document.getElementById('students-container');
                studentsContainer.innerHTML = '<p class="loading">Loading students...</p>';
                
                // Build query based on filter
                let q;
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                
                switch (filterType) {
                    case 'active':
                        // Active students have submitted assessments in the last 30 days
                        // This would require a more complex query in a real app
                        q = query(
                            collection(db, "users"), 
                            where("role", "==", "student"),
                            orderBy("createdAt", "desc")
                        );
                        break;
                    case 'recent':
                        q = query(
                            collection(db, "users"), 
                            where("role", "==", "student"),
                            where("createdAt", ">=", sevenDaysAgo),
                            orderBy("createdAt", "desc")
                        );
                        break;
                    default:
                        q = query(
                            collection(db, "users"), 
                            where("role", "==", "student"),
                            orderBy("createdAt", "desc")
                        );
                }
                
                // Get total count for pagination
                const countSnapshot = await getDocs(q);
                const totalStudents = countSnapshot.size;
                document.getElementById('student-count').textContent = totalStudents;
                totalStudentPages = Math.ceil(totalStudents / ITEMS_PER_PAGE);
                
                // Apply pagination
                if (page === 1) {
                    q = query(q, limit(ITEMS_PER_PAGE));
                    lastStudentDoc = null;
                } else if (lastStudentDoc) {
                    q = query(q, startAfter(lastStudentDoc), limit(ITEMS_PER_PAGE));
                }
                
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    studentsContainer.innerHTML = `
                        <div class="empty-state">
                            <p>No students have registered yet.</p>
                        </div>
                    `;
                    return;
                }
                
                // Save the last document for pagination
                lastStudentDoc = querySnapshot.docs[querySnapshot.docs.length - 1];
                
                // Create table of students
                let studentsTable = `
                    <table class="data-table" id="students-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Registration Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                querySnapshot.forEach((doc) => {
                    const student = doc.data();
                    const registrationDate = student.createdAt ? 
                        new Date(student.createdAt.seconds * 1000).toLocaleDateString() : 
                        'Unknown';
                    
                    // Apply search filter if provided
                    if (searchTerm && !(
                        (student.fullName && student.fullName.toLowerCase().includes(searchTerm.toLowerCase())) ||
                        (student.email && student.email.toLowerCase().includes(searchTerm.toLowerCase()))
                    )) {
                        return; // Skip this item if it doesn't match search
                    }
                    
                    studentsTable += `
                        <tr data-id="${doc.id}">
                            <td>${student.fullName || 'Unknown'}</td>
                            <td>${student.email || 'Unknown'}</td>
                            <td>${registrationDate}</td>
                            <td class="action-buttons">
                                <button class="btn-small btn-view" onclick="viewStudentProfile('${doc.id}')">View Profile</button>
                            </td>
                        </tr>
                    `;
                });
                
                studentsTable += `
                        </tbody>
                    </table>
                `;
                
                studentsContainer.innerHTML = studentsTable;
                
                // Update pagination
                updatePagination('students', currentStudentsPage, totalStudentPages);
                
            } catch (error) {
                console.error("Error loading students:", error);
                document.getElementById('students-container').innerHTML = `
                    <p class="error">Error loading students: ${error.message}</p>
                `;
            }
        }
        
        // Update pagination controls
        function updatePagination(tabId, currentPage, totalPages) {
            const paginationContainer = document.getElementById(`${tabId}-pagination`);
            
            if (totalPages <= 1) {
                paginationContainer.style.display = 'none';
                return;
            }
            
            paginationContainer.style.display = 'flex';
            
            let paginationHTML = '';
            
            // Previous button
            paginationHTML += `
                <button class="pagination-button ${currentPage === 1 ? 'disabled' : ''}" 
                    ${currentPage === 1 ? 'disabled' : `onclick="changePage('${tabId}', ${currentPage - 1})"`}>
                    &laquo; Previous
                </button>
            `;
            
            // Page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            if (startPage > 1) {
                paginationHTML += `
                    <button class="pagination-button" onclick="changePage('${tabId}', 1)">1</button>
                    ${startPage > 2 ? '<span class="pagination-ellipsis">...</span>' : ''}
                `;
            }
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <button class="pagination-button ${i === currentPage ? 'active' : ''}" 
                        onclick="changePage('${tabId}', ${i})">
                        ${i}
                    </button>
                `;
            }
            
            if (endPage < totalPages) {
                paginationHTML += `
                    ${endPage < totalPages - 1 ? '<span class="pagination-ellipsis">...</span>' : ''}
                    <button class="pagination-button" onclick="changePage('${tabId}', ${totalPages})">
                        ${totalPages}
                    </button>
                `;
            }
            
            // Next button
            paginationHTML += `
                <button class="pagination-button ${currentPage === totalPages ? 'disabled' : ''}" 
                    ${currentPage === totalPages ? 'disabled' : `onclick="changePage('${tabId}', ${currentPage + 1})"`}>
                    Next &raquo;
                </button>
            `;
            
            paginationContainer.innerHTML = paginationHTML;
        }
        
        // Change page
        window.changePage = function(tabId, page) {
            switch (tabId) {
                case 'assessments':
                    currentAssessmentsPage = page;
                    loadAllAssessments(currentAssessmentsFilter, document.getElementById('assessment-search').value, page);
                    break;
                case 'budgets':
                    currentBudgetsPage = page;
                    loadAllBudgets(currentBudgetsFilter, document.getElementById('budget-search').value, page);
                    break;
                case 'students':
                    currentStudentsPage = page;
                    loadAllStudents(currentStudentsFilter, document.getElementById('student-search').value, page);
                    break;
            }
        };
        
        // Set up tab switching
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Deactivate all tabs
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Activate the selected tab
                    const tabId = this.getAttribute('data-tab');
                    this.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }
        
        // Set up search functionality
        function setupSearch() {
            // Assessment search
            document.getElementById('assessment-search').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                loadAllAssessments(currentAssessmentsFilter, searchTerm, 1);
            });
            
            // Budget search
            document.getElementById('budget-search').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                loadAllBudgets(currentBudgetsFilter, searchTerm, 1);
            });
            
            // Student search
            document.getElementById('student-search').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                loadAllStudents(currentStudentsFilter, searchTerm, 1);
            });
        }
        
        // Set up filters
        function setupFilters() {
            // Assessment filters
            document.querySelectorAll('#assessments .filter-option').forEach(option => {
                option.addEventListener('click', function() {
                    // Update active state
                    document.querySelectorAll('#assessments .filter-option').forEach(opt => 
                        opt.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Apply filter
                    const filterType = this.getAttribute('data-filter');
                    currentAssessmentsFilter = filterType;
                    loadAllAssessments(filterType, document.getElementById('assessment-search').value, 1);
                });
            });
            
            // Budget filters
            document.querySelectorAll('#budgets .filter-option').forEach(option => {
                option.addEventListener('click', function() {
                    // Update active state
                    document.querySelectorAll('#budgets .filter-option').forEach(opt => 
                        opt.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Apply filter
                    const filterType = this.getAttribute('data-filter');
                    currentBudgetsFilter = filterType;
                    loadAllBudgets(filterType, document.getElementById('budget-search').value, 1);
                });
            });
            
            // Student filters
            document.querySelectorAll('#students .filter-option').forEach(option => {
                option.addEventListener('click', function() {
                    // Update active state
                    document.querySelectorAll('#students .filter-option').forEach(opt => 
                        opt.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Apply filter
                    const filterType = this.getAttribute('data-filter');
                    currentStudentsFilter = filterType;
                    loadAllStudents(filterType, document.getElementById('student-search').value, 1);
                });
            });
        }
        
        // Format currency
        function formatCurrency(amount) {
            return '$' + Number(amount).toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        // View budget details
        window.viewBudget = function(budgetId) {
            window.location.href = `view-budget.html?id=${budgetId}`;
        };
    
        // View student profile
        window.viewStudentProfile = function(studentId) {
            window.location.href = `view-student.html?id=${studentId}`;
        };
    </script>
</body>
</html>