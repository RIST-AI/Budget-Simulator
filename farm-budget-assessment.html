<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="description" content="Farm Budget Assessment for AHCBUS408 Budget Master - Create and analyze agricultural budgets">
    <title>Farm Budget Assessment - AHCBUS408 Budget Master</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="images/RIST Brandmark - Navy Circle.png" type="image/png">
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo-container">
                    <img src="images/RIST - Primary Colour.jpg" alt="RIST - Rural Industries Skill Training" class="rist-logo">
                </div>
                <div class="title-container">
                    <h1>AHCBUS408 Budget Master</h1>
                    <p>Agricultural Budgeting Training Tool</p>
                </div>
                <div id="user-status" class="user-status">
                    <!-- Login status will be shown here -->
                </div>
            </div>
        </div>
    </header>
    <nav>
        <div class="container">
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="budget.html">Budget Simulator</a></li>
                <li><a href="farm-budget-assessment.html" class="active">Assessment</a></li>
                <li id="dashboard-nav-item"><a href="#" id="dashboard-link">Dashboard</a></li>
                <li id="logout-nav-item"><a href="#" id="logout-link">Logout</a></li>
            </ul>
        </div>
    </nav>

    <main class="container">
        <div class="assessment-container">
            <div class="assessment-header">
                <h2>Farm Budget Management Assessment</h2>
                <p>Create a farm budget, track actual performance, and analyze variances to demonstrate your budget management skills.</p>
            </div>
            
            <div class="assessment-progress">
                <div class="progress-step active" id="step1">
                    1
                    <div class="step-label">Student Info</div>
                </div>
                <div class="progress-step" id="step2">
                    2
                    <div class="step-label">Budget Creation</div>
                </div>
                <div class="progress-step" id="step3">
                    3
                    <div class="step-label">Actual Results</div>
                </div>
                <div class="progress-step" id="step4">
                    4
                    <div class="step-label">Variance Analysis</div>
                </div>
                <div class="progress-step" id="step5">
                    5
                    <div class="step-label">Recommendations</div>
                </div>
                <div class="progress-step" id="step6">
                    6
                    <div class="step-label">Final Report</div>
                </div>
            </div>
            
            <div class="tabs">
                <div class="tab-buttons">
                    <button class="tab-button active" data-tab="student-info">Student Information</button>
                    <button class="tab-button" data-tab="budget-creation">Budget Creation</button>
                    <button class="tab-button" data-tab="actual-results">Actual Results</button>
                    <button class="tab-button" data-tab="variance-analysis">Variance Analysis</button>
                    <button class="tab-button" data-tab="recommendations">Recommendations</button>
                    <button class="tab-button" data-tab="final-report">Final Report</button>
                </div>
                
                <div id="student-info" class="tab-content active">
                    <h3>Student Information</h3>
                    <p>Please provide your details below.</p>
                    
                    <form id="student-info-form">
                        <div class="student-info-grid">
                            <div class="form-group">
                                <label for="student-name">Full Name:</label>
                                <input type="text" id="student-name" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="student-id">Student ID:</label>
                                <input type="text" id="student-id" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="unit-code">Unit Code:</label>
                                <input type="text" id="unit-code" value="AHCBUS408" readonly>
                            </div>
                            
                            <div class="form-group">
                                <label for="assessment-date">Assessment Date:</label>
                                <input type="date" id="assessment-date" required>
                            </div>
                        </div>
                        
                        <div class="btn-group">
                            <div></div>
                            <button type="button" class="btn" id="next-to-budget">Next: Budget Creation</button>
                        </div>
                    </form>
                </div>
                
                <div id="budget-creation" class="tab-content">
                    <h3>Budget Creation</h3>
                    <p>Create a farm budget by adding income and expense items.</p>
                    
                    <div class="form-group">
                        <label for="farm-type">Farm Type:</label>
                        <select id="farm-type">
                            <option value="dairy">Dairy Farm</option>
                            <option value="crop">Crop Farm</option>
                            <option value="livestock">Livestock Farm</option>
                            <option value="mixed">Mixed Farm</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="budget-period">Budget Period:</label>
                        <select id="budget-period">
                            <option value="monthly">Monthly</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="annual">Annual</option>
                        </select>
                    </div>
                    
                    <h4>Add Budget Items</h4>
                    <form id="budget-item-form">
                        <div class="budget-item-form">
                            <div class="form-group">
                                <label for="item-name">Item Name:</label>
                                <input type="text" id="item-name" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="item-category">Category:</label>
                                <select id="item-category" required>
                                    <option value="">Select Category</option>
                                    <option value="income">Income</option>
                                    <option value="expense">Expense</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="item-subcategory">Subcategory:</label>
                                <select id="item-subcategory" required>
                                    <option value="">Select Subcategory</option>
                                    <!-- Subcategories will be populated based on category selection -->
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="item-amount">Budgeted Amount ($):</label>
                                <input type="number" id="item-amount" min="0" step="0.01" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="item-notes">Notes:</label>
                                <input type="text" id="item-notes">
                            </div>
                            
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <button type="button" class="btn" id="add-budget-item">Add Item</button>
                            </div>
                        </div>
                    </form>
                    
                    <h4>Budget Items</h4>
                    <div class="budget-grid">
                        <table class="budget-items-table" id="budget-items-table">
                            <thead>
                                <tr>
                                    <th>Item Name</th>
                                    <th>Category</th>
                                    <th>Subcategory</th>
                                    <th>Amount ($)</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="budget-items-body">
                                <!-- Budget items will be added here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="budget-summary">
                        <div class="budget-summary-item">
                            <div class="label">Total Income</div>
                            <div class="value" id="total-income">$0.00</div>
                        </div>
                        <div class="budget-summary-item">
                            <div class="label">Total Expenses</div>
                            <div class="value" id="total-expenses">$0.00</div>
                        </div>
                        <div class="budget-summary-item">
                            <div class="label">Net Result</div>
                            <div class="value" id="net-result">$0.00</div>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" id="back-to-student">Back: Student Info</button>
                        <button type="button" class="btn" id="next-to-actuals">Next: Actual Results</button>
                    </div>
                </div>
                
                <div id="actual-results" class="tab-content">
                    <h3>Actual Results</h3>
                    <p>Enter the actual amounts for each budget item.</p>
                    
                    <div class="budget-grid">
                        <table class="actuals-table" id="actuals-table">
                            <thead>
                                <tr>
                                    <th>Item Name</th>
                                    <th>Category</th>
                                    <th>Budgeted Amount ($)</th>
                                    <th>Actual Amount ($)</th>
                                    <th>Variance ($)</th>
                                </tr>
                            </thead>
                            <tbody id="actuals-body">
                                <!-- Actual results will be added here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="budget-summary">
                        <div class="budget-summary-item">
                            <div class="label">Total Income</div>
                            <div class="value" id="actual-income">$0.00</div>
                        </div>
                        <div class="budget-summary-item">
                            <div class="label">Total Expenses</div>
                            <div class="value" id="actual-expenses">$0.00</div>
                        </div>
                        <div class="budget-summary-item">
                            <div class="label">Net Result</div>
                            <div class="value" id="actual-net-result">$0.00</div>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" id="back-to-budget">Back: Budget Creation</button>
                        <button type="button" class="btn" id="next-to-variance">Next: Variance Analysis</button>
                    </div>
                </div>
                
                <div id="variance-analysis" class="tab-content">
                    <h3>Variance Analysis</h3>
                    <p>Analyze the significant variances between budgeted and actual amounts.</p>
                    
                    <div class="budget-grid">
                        <table class="variance-table" id="variance-table">
                            <thead>
                                <tr>
                                    <th>Item Name</th>
                                    <th>Budgeted ($)</th>
                                    <th>Actual ($)</th>
                                    <th>Variance ($)</th>
                                    <th>Variance (%)</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="variance-body">
                                <!-- Variance items will be added here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="variance-form" style="display: none;">
                        <h4>Variance Analysis for: <span id="variance-item-name"></span></h4>
                        
                        <div class="form-group">
                            <label for="variance-cause">Cause of Variance:</label>
                            <select id="variance-cause" required>
                                <option value="">Select Cause</option>
                                <option value="price-change">Price Change</option>
                                <option value="volume-change">Volume/Quantity Change</option>
                                <option value="timing-difference">Timing Difference</option>
                                <option value="unexpected-event">Unexpected Event</option>
                                <option value="estimation-error">Estimation Error</option>
                                <option value="efficiency-change">Efficiency Change</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="variance-explanation">Explanation:</label>
                            <textarea id="variance-explanation" rows="3" required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <button type="button" class="btn" id="save-variance">Save Analysis</button>
                            <button type="button" class="btn btn-secondary" id="cancel-variance">Cancel</button>
                        </div>
                    </div>
                    
                    <h4>Overall Budget Performance Assessment</h4>
                    <div class="form-group">
                        <textarea id="overall-assessment" rows="5" placeholder="Provide an overall assessment of the budget performance..."></textarea>
                    </div>
                    
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" id="back-to-actuals">Back: Actual Results</button>
                        <button type="button" class="btn" id="next-to-recommendations">Next: Recommendations</button>
                    </div>
                </div>
                
                <div id="recommendations" class="tab-content">
                    <h3>Recommendations</h3>
                    <p>Based on your variance analysis, provide recommendations for improving budget performance.</p>
                    
                    <div id="recommendations-list">
                        <!-- Recommendations will be added here -->
                    </div>
                    
                    <h4>Add Recommendation</h4>
                    <div class="form-group">
                        <label for="recommendation-title">Title:</label>
                        <input type="text" id="recommendation-title" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="recommendation-details">Details:</label>
                        <textarea id="recommendation-details" rows="3" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <button type="button" class="btn" id="add-recommendation">Add Recommendation</button>
                    </div>
                    
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" id="back-to-variance">Back: Variance Analysis</button>
                        <button type="button" class="btn" id="next-to-report">Next: Final Report</button>
                    </div>
                </div>
                
                <div id="final-report" class="tab-content">
                    <h3>Final Report</h3>
                    <p>Summarize your findings and recommendations in a final report.</p>
                    
                    <div class="form-group">
                        <label for="final-report-text">Final Report:</label>
                        <textarea id="final-report-text" rows="10" placeholder="Write your final report here..."></textarea>
                    </div>
                    
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" id="back-to-recommendations">Back: Recommendations</button>
                        <button type="button" class="btn btn-success" id="submit-assessment">Submit Assessment</button>
                    </div>
                </div>
            </div>
            
            <div id="save-status" class="mt-20" style="display: none;">
                <p>Draft saved automatically at <span id="save-time"></span></p>
            </div>
            
            <div class="btn-group mt-20">
                <button type="button" class="btn btn-secondary" id="save-draft">Save Draft</button>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <img src="images/RIST Brandmark - Navy Circle.png" alt="RIST" class="rist-logo-footer">
                </div>
                <div class="footer-info">
                    <p>&copy; 2025 RIST - Rural Industries Skill Training</p>
                    <p>AHCBUS408 Budget Master</p>
                </div>
                <div class="footer-contact">
                    <p>Contact: <a href="mailto:info@rist.com.au">info@rist.com.au</a></p>
                </div>
            </div>
        </div>
    </footer>

    <script type="module">
        import { auth, onAuthStateChanged, signOut, db, doc, getDoc, setDoc, addDoc, collection } from './js/firebase-config.js';
        
        // Global variables
        let currentUser = null;
        let budgetItems = [];
        let varianceAnalyses = [];
        let recommendations = [];
        let currentVarianceItemId = null;
        let autoSaveTimer = null;
        let lastSaveTime = null;
        
        // Check authentication first using localStorage
        document.addEventListener('DOMContentLoaded', function() {
            // First check localStorage for a stored user
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                document.getElementById('user-status').innerHTML = 'Logged in as: ' + currentUser.email;
                
                // Set dashboard link based on role
                const storedRole = localStorage.getItem('userRole');
                if (storedRole === 'trainer') {
                    document.getElementById('dashboard-link').href = 'trainer-dashboard.html';
                } else {
                    document.getElementById('dashboard-link').href = 'student-dashboard.html';
                }
                
                // Initialize the assessment form
                initializeAssessment();
            } else {
                // If no stored user, check Firebase auth
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        document.getElementById('user-status').innerHTML = 'Logged in as: ' + user.email;
                        
                        // Store user in localStorage for persistence
                        localStorage.setItem('currentUser', JSON.stringify({
                            uid: user.uid,
                            email: user.email
                        }));
                        
                        // Check user role for dashboard link
                        getDoc(doc(db, 'users', user.uid)).then(userDoc => {
                            if (userDoc.exists()) {
                                const role = userDoc.data().role;
                                localStorage.setItem('userRole', role);
                                
                                if (role === 'trainer') {
                                    document.getElementById('dashboard-link').href = 'trainer-dashboard.html';
                                } else {
                                    document.getElementById('dashboard-link').href = 'student-dashboard.html';
                                }
                            }
                        }).catch(error => {
                            console.error("Error checking user role:", error);
                        });
                        
                        // Initialize the assessment form
                        initializeAssessment();
                    } else {
                        // Not authenticated, redirect to login
                        window.location.href = 'login.html';
                    }
                });
            }
            
            // Logout functionality
            document.getElementById('logout-link').addEventListener('click', function(e) {
                e.preventDefault();
                
                // Save draft before logging out
                saveAssessmentDraft().then(() => {
                    // Clear localStorage
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('userRole');
                    
                    // Also sign out from Firebase
                    signOut(auth).then(() => {
                        // Sign-out successful
                        window.location.href = 'login.html';
                    }).catch((error) => {
                        // An error happened
                        console.error("Error signing out:", error);
                        // Still redirect to login
                        window.location.href = 'login.html';
                    });
                });
            });
        });
        
        // Initialize assessment
        function initializeAssessment() {
            // Set up tab switching
            setupTabs();
            
            // Set up navigation buttons
            setupNavigation();
            
            // Set up budget item form
            setupBudgetItemForm();
            
            // Set up actuals form
            setupActualsForm();
            
            // Set up variance analysis
            setupVarianceAnalysis();
            
            // Set up recommendations
            setupRecommendations();
            
            // Set up save draft button
            document.getElementById('save-draft').addEventListener('click', function() {
                saveAssessmentDraft().then(() => {
                    alert('Draft saved successfully!');
                });
            });
            
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('assessment-date').value = today;
            
            // Load saved draft
            loadSavedDraft();
            
            // Set up auto-save
            setupAutoSave();
        }
        
        // The rest of your existing functions remain unchanged
        // ...
        
        // Save assessment draft
        async function saveAssessmentDraft() {
            if (!currentUser) return Promise.reject(new Error("Not authenticated"));
            
            try {
                // Collect all form data
                const formData = {
                    studentName: document.getElementById('student-name').value,
                    studentId: document.getElementById('student-id').value,
                    assessmentDate: document.getElementById('assessment-date').value,
                    farmType: document.getElementById('farm-type').value,
                    budgetPeriod: document.getElementById('budget-period').value,
                    budgetItems: budgetItems,
                    variances: varianceAnalyses,
                    overallAssessment: document.getElementById('overall-assessment').value,
                    recommendations: recommendations,
                    finalReport: document.getElementById('final-report-text').value,
                    lastUpdated: new Date()
                };
                
                // Save to Firestore
                const userRef = doc(db, "users", currentUser.uid);
                const draftRef = doc(collection(userRef, "assessmentDrafts"), "currentDraft");
                
                await setDoc(draftRef, formData);
                console.log("Draft saved");
                
                // Update save status
                lastSaveTime = new Date();
                document.getElementById('save-time').textContent = lastSaveTime.toLocaleTimeString();
                document.getElementById('save-status').style.display = 'block';
                
                // Also save to localStorage as backup
                localStorage.setItem('assessment_data', JSON.stringify(formData));
                
                return Promise.resolve();
            } catch (error) {
                console.error("Error saving draft:", error);
                return Promise.reject(error);
            }
        }
        
        // Load saved draft
        async function loadSavedDraft() {
            if (!currentUser) return;
            
            try {
                // Try to load from Firestore first
                const userRef = doc(db, "users", currentUser.uid);
                const draftRef = doc(collection(userRef, "assessmentDrafts"), "currentDraft");
                
                const docSnap = await getDoc(draftRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Populate form fields
                    if (data.studentName) document.getElementById('student-name').value = data.studentName;
                    if (data.studentId) document.getElementById('student-id').value = data.studentId;
                    if (data.assessmentDate) document.getElementById('assessment-date').value = data.assessmentDate;
                    if (data.farmType) document.getElementById('farm-type').value = data.farmType;
                    if (data.budgetPeriod) document.getElementById('budget-period').value = data.budgetPeriod;
                    
                    // Load budget items
                    if (data.budgetItems && Array.isArray(data.budgetItems)) {
                        budgetItems = data.budgetItems;
                        updateBudgetItemsTable();
                        updateBudgetSummary();
                    }
                    
                    // Load variance analyses
                    if (data.variances && Array.isArray(data.variances)) {
                        varianceAnalyses = data.variances;
                    }
                    
                    // Load overall assessment
                    if (data.overallAssessment) document.getElementById('overall-assessment').value = data.overallAssessment;
                    
                    // Load recommendations
                    if (data.recommendations && Array.isArray(data.recommendations)) {
                        recommendations = data.recommendations;
                        updateRecommendationsList();
                    }
                    
                    // Load final report
                    if (data.finalReport) document.getElementById('final-report-text').value = data.finalReport;
                    
                    // Update save status
                    if (data.lastUpdated) {
                        lastSaveTime = new Date(data.lastUpdated.seconds * 1000);
                        document.getElementById('save-time').textContent = lastSaveTime.toLocaleTimeString();
                        document.getElementById('save-status').style.display = 'block';
                    }
                    
                    console.log("Draft loaded from Firestore");
                } else {
                    // Fall back to localStorage
                    const savedData = localStorage.getItem('assessment_data');
                    if (savedData) {
                        const data = JSON.parse(savedData);
                        
                        // Populate form fields (same as above)
                        if (data.studentName) document.getElementById('student-name').value = data.studentName;
                        if (data.studentId) document.getElementById('student-id').value = data.studentId;
                        if (data.assessmentDate) document.getElementById('assessment-date').value = data.assessmentDate;
                        if (data.farmType) document.getElementById('farm-type').value = data.farmType;
                        if (data.budgetPeriod) document.getElementById('budget-period').value = data.budgetPeriod;
                        
                        // Load budget items
                        if (data.budgetItems && Array.isArray(data.budgetItems)) {
                            budgetItems = data.budgetItems;
                            updateBudgetItemsTable();
                            updateBudgetSummary();
                        }
                        
                        // Load variance analyses
                        if (data.variances && Array.isArray(data.variances)) {
                            varianceAnalyses = data.variances;
                        }
                        
                        // Load overall assessment
                        if (data.overallAssessment) document.getElementById('overall-assessment').value = data.overallAssessment;
                        
                        // Load recommendations
                        if (data.recommendations && Array.isArray(data.recommendations)) {
                            recommendations = data.recommendations;
                            updateRecommendationsList();
                        }
                        
                        // Load final report
                        if (data.finalReport) document.getElementById('final-report-text').value = data.finalReport;
                        
                        console.log("Draft loaded from localStorage");
                    } else {
                        // No saved draft found
                        console.log("No saved draft found");
                    }
                }
            } catch (error) {
                console.error("Error loading draft:", error);
            }
        }
        
        // Set up auto-save
        function setupAutoSave() {
            // Clear any existing timer
            if (autoSaveTimer) clearInterval(autoSaveTimer);
            
            // Set up auto-save every 30 seconds
            autoSaveTimer = setInterval(() => {
                if (currentUser) {
                    saveAssessmentDraft().catch(error => {
                        console.error("Auto-save error:", error);
                    });
                }
            }, 30000); // 30 seconds
        }
        
        // The rest of your existing code remains unchanged
        // ...
    </script>
</body>
</html>