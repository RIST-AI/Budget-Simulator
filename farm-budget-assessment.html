<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="description" content="Farm Budget Assessment for AHCBUS408 Budget Master - Create and analyze agricultural budgets">
    <title>Farm Budget Assessment - AHCBUS408 Budget Master</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="images/RIST Brandmark - Navy Circle.png" type="image/png">
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo-container">
                    <img src="images/RIST - Primary Colour.jpg" alt="RIST - Rural Industries Skill Training" class="rist-logo">
                </div>
                <div class="title-container">
                    <h1>AHCBUS408 Budget Master</h1>
                    <p>Agricultural Budgeting Training Tool</p>
                </div>
                <div id="user-status" class="user-status">
                    <!-- Login status will be shown here -->
                </div>
            </div>
        </div>
    </header>
    <nav>
        <div class="container">
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="budget.html">Budget Simulator</a></li>
                <li><a href="farm-budget-assessment.html" class="active">Assessment</a></li>
                <li id="dashboard-nav-item"><a href="#" id="dashboard-link">Dashboard</a></li>
                <li id="logout-nav-item"><a href="#" id="logout-link">Logout</a></li>
            </ul>
        </div>
    </nav>

    <main class="container">
        <div class="assessment-container">
            <div class="assessment-header">
                <h2>Farm Budget Management Assessment</h2>
                <p>Create a farm budget, track actual performance, and analyze variances to demonstrate your budget management skills.</p>
            </div>
            
            <div class="assessment-progress">
                <div class="progress-step active" id="step1">
                    1
                    <div class="step-label">Student Info</div>
                </div>
                <div class="progress-step" id="step2">
                    2
                    <div class="step-label">Budget Creation</div>
                </div>
                <div class="progress-step" id="step3">
                    3
                    <div class="step-label">Actual Results</div>
                </div>
                <div class="progress-step" id="step4">
                    4
                    <div class="step-label">Variance Analysis</div>
                </div>
                <div class="progress-step" id="step5">
                    5
                    <div class="step-label">Recommendations</div>
                </div>
                <div class="progress-step" id="step6">
                    6
                    <div class="step-label">Final Report</div>
                </div>
            </div>
            
            <div class="tabs">
                <div class="tab-buttons">
                    <button class="tab-button active" data-tab="student-info">Student Information</button>
                    <button class="tab-button" data-tab="budget-creation">Budget Creation</button>
                    <button class="tab-button" data-tab="actual-results">Actual Results</button>
                    <button class="tab-button" data-tab="variance-analysis">Variance Analysis</button>
                    <button class="tab-button" data-tab="recommendations">Recommendations</button>
                    <button class="tab-button" data-tab="final-report">Final Report</button>
                </div>
                
                <div id="student-info" class="tab-content active">
                    <h3>Student Information</h3>
                    <p>Please provide your details below.</p>
                    
                    <form id="student-info-form">
                        <div class="student-info-grid">
                            <div class="form-group">
                                <label for="student-name">Full Name:</label>
                                <input type="text" id="student-name" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="student-id">Student ID:</label>
                                <input type="text" id="student-id" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="unit-code">Unit Code:</label>
                                <input type="text" id="unit-code" value="AHCBUS408" readonly>
                            </div>
                            
                            <div class="form-group">
                                <label for="assessment-date">Assessment Date:</label>
                                <input type="date" id="assessment-date" required>
                            </div>
                        </div>
                        
                        <div class="btn-group">
                            <div></div>
                            <button type="button" class="btn" id="next-to-budget">Next: Budget Creation</button>
                        </div>
                    </form>
                </div>
                
                <div id="budget-creation" class="tab-content">
                    <h3>Budget Creation</h3>
                    <p>Create a farm budget by adding income and expense items.</p>
                    
                    <div class="form-group">
                        <label for="farm-type">Farm Type:</label>
                        <select id="farm-type">
                            <option value="dairy">Dairy Farm</option>
                            <option value="crop">Crop Farm</option>
                            <option value="livestock">Livestock Farm</option>
                            <option value="mixed">Mixed Farm</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="budget-period">Budget Period:</label>
                        <select id="budget-period">
                            <option value="monthly">Monthly</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="annual">Annual</option>
                        </select>
                    </div>
                    
                    <h4>Add Budget Items</h4>
                    <form id="budget-item-form">
                        <div class="budget-item-form">
                            <div class="form-group">
                                <label for="item-name">Item Name:</label>
                                <input type="text" id="item-name" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="item-category">Category:</label>
                                <select id="item-category" required>
                                    <option value="">Select Category</option>
                                    <option value="income">Income</option>
                                    <option value="expense">Expense</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="item-subcategory">Subcategory:</label>
                                <select id="item-subcategory" required>
                                    <option value="">Select Subcategory</option>
                                    <!-- Subcategories will be populated based on category selection -->
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="item-amount">Budgeted Amount ($):</label>
                                <input type="number" id="item-amount" min="0" step="0.01" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="item-notes">Notes:</label>
                                <input type="text" id="item-notes">
                            </div>
                            
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <button type="button" class="btn" id="add-budget-item">Add Item</button>
                            </div>
                        </div>
                    </form>
                    
                    <h4>Budget Items</h4>
                    <div class="budget-grid">
                        <table class="budget-items-table" id="budget-items-table">
                            <thead>
                                <tr>
                                    <th>Item Name</th>
                                    <th>Category</th>
                                    <th>Subcategory</th>
                                    <th>Amount ($)</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="budget-items-body">
                                <!-- Budget items will be added here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="budget-summary">
                        <div class="budget-summary-item">
                            <div class="label">Total Income</div>
                            <div class="value" id="total-income">$0.00</div>
                        </div>
                        <div class="budget-summary-item">
                            <div class="label">Total Expenses</div>
                            <div class="value" id="total-expenses">$0.00</div>
                        </div>
                        <div class="budget-summary-item">
                            <div class="label">Net Result</div>
                            <div class="value" id="net-result">$0.00</div>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" id="back-to-student">Back: Student Info</button>
                        <button type="button" class="btn" id="next-to-actuals">Next: Actual Results</button>
                    </div>
                </div>
                
                <div id="actual-results" class="tab-content">
                    <h3>Actual Results</h3>
                    <p>Enter the actual amounts for each budget item.</p>
                    
                    <div class="budget-grid">
                        <table class="actuals-table" id="actuals-table">
                            <thead>
                                <tr>
                                    <th>Item Name</th>
                                    <th>Category</th>
                                    <th>Budgeted Amount ($)</th>
                                    <th>Actual Amount ($)</th>
                                    <th>Variance ($)</th>
                                </tr>
                            </thead>
                            <tbody id="actuals-body">
                                <!-- Actual results will be added here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="budget-summary">
                        <div class="budget-summary-item">
                            <div class="label">Total Income</div>
                            <div class="value" id="actual-income">$0.00</div>
                        </div>
                        <div class="budget-summary-item">
                            <div class="label">Total Expenses</div>
                            <div class="value" id="actual-expenses">$0.00</div>
                        </div>
                        <div class="budget-summary-item">
                            <div class="label">Net Result</div>
                            <div class="value" id="actual-net-result">$0.00</div>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" id="back-to-budget">Back: Budget Creation</button>
                        <button type="button" class="btn" id="next-to-variance">Next: Variance Analysis</button>
                    </div>
                </div>
                
                <div id="variance-analysis" class="tab-content">
                    <h3>Variance Analysis</h3>
                    <p>Analyze the significant variances between budgeted and actual amounts.</p>
                    
                    <div class="budget-grid">
                        <table class="variance-table" id="variance-table">
                            <thead>
                                <tr>
                                    <th>Item Name</th>
                                    <th>Budgeted ($)</th>
                                    <th>Actual ($)</th>
                                    <th>Variance ($)</th>
                                    <th>Variance (%)</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="variance-body">
                                <!-- Variance items will be added here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="variance-form" style="display: none;">
                        <h4>Variance Analysis for: <span id="variance-item-name"></span></h4>
                        
                        <div class="form-group">
                            <label for="variance-cause">Cause of Variance:</label>
                            <select id="variance-cause" required>
                                <option value="">Select Cause</option>
                                <option value="price-change">Price Change</option>
                                <option value="volume-change">Volume/Quantity Change</option>
                                <option value="timing-difference">Timing Difference</option>
                                <option value="unexpected-event">Unexpected Event</option>
                                <option value="estimation-error">Estimation Error</option>
                                <option value="efficiency-change">Efficiency Change</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="variance-explanation">Explanation:</label>
                            <textarea id="variance-explanation" rows="3" required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <button type="button" class="btn" id="save-variance">Save Analysis</button>
                            <button type="button" class="btn btn-secondary" id="cancel-variance">Cancel</button>
                        </div>
                    </div>
                    
                    <h4>Overall Budget Performance Assessment</h4>
                    <div class="form-group">
                        <textarea id="overall-assessment" rows="5" placeholder="Provide an overall assessment of the budget performance..."></textarea>
                    </div>
                    
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" id="back-to-actuals">Back: Actual Results</button>
                        <button type="button" class="btn" id="next-to-recommendations">Next: Recommendations</button>
                    </div>
                </div>
                
                <div id="recommendations" class="tab-content">
                    <h3>Recommendations</h3>
                    <p>Based on your variance analysis, provide recommendations for improving budget performance.</p>
                    
                    <div id="recommendations-list">
                        <!-- Recommendations will be added here -->
                    </div>
                    
                    <h4>Add Recommendation</h4>
                    <div class="form-group">
                        <label for="recommendation-title">Title:</label>
                        <input type="text" id="recommendation-title" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="recommendation-details">Details:</label>
                        <textarea id="recommendation-details" rows="3" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <button type="button" class="btn" id="add-recommendation">Add Recommendation</button>
                    </div>
                    
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" id="back-to-variance">Back: Variance Analysis</button>
                        <button type="button" class="btn" id="next-to-report">Next: Final Report</button>
                    </div>
                </div>
                
                <div id="final-report" class="tab-content">
                    <h3>Final Report</h3>
                    <p>Summarize your findings and recommendations in a final report.</p>
                    
                    <div class="form-group">
                        <label for="final-report-text">Final Report:</label>
                        <textarea id="final-report-text" rows="10" placeholder="Write your final report here..."></textarea>
                    </div>
                    
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" id="back-to-recommendations">Back: Recommendations</button>
                        <button type="button" class="btn btn-success" id="submit-assessment">Submit Assessment</button>
                    </div>
                </div>
            </div>
            
            <div id="save-status" class="mt-20" style="display: none;">
                <p>Draft saved automatically at <span id="save-time"></span></p>
            </div>
            
            <div class="btn-group mt-20">
                <button type="button" class="btn btn-secondary" id="save-draft">Save Draft</button>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <img src="images/RIST Brandmark - Navy Circle.png" alt="RIST" class="rist-logo-footer">
                </div>
                <div class="footer-info">
                    <p>&copy; 2025 RIST - Rural Industries Skill Training</p>
                    <p>AHCBUS408 Budget Master</p>
                </div>
                <div class="footer-contact">
                    <p>Contact: <a href="mailto:info@rist.com.au">info@rist.com.au</a></p>
                </div>
            </div>
        </div>
    </footer>

    <script type="module">
        import { checkAuth } from './js/auth.js';
        import { 
            auth, 
            onAuthStateChanged, 
            signOut, 
            db, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            collection,
            setPersistence,
            browserLocalPersistence
        } from './js/firebase-config.js';
        
        // Set persistence to LOCAL (survives browser restarts)
        setPersistence(auth, browserLocalPersistence)
          .then(() => {
            console.log("Persistence set to LOCAL");
          })
          .catch((error) => {
            console.error("Error setting persistence:", error);
          });
        
        // Global variables
        let currentUser = null;
        let budgetItems = [];
        let varianceAnalyses = [];
        let recommendations = [];
        let currentVarianceItemId = null;
        let autoSaveTimer = null;
        let lastSaveTime = null;
        
        // Check authentication once at page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth().then(isAuthenticated => {
                if (!isAuthenticated) return;
                
                // Set up a single auth state observer
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        document.getElementById('user-status').innerHTML = 'Logged in as: ' + user.email;
                        
                        // Check user role for dashboard link
                        getDoc(doc(db, 'users', user.uid)).then(userDoc => {
                            if (userDoc.exists()) {
                                const role = userDoc.data().role;
                                if (role === 'trainer') {
                                    document.getElementById('dashboard-link').href = 'trainer-dashboard.html';
                                } else {
                                    document.getElementById('dashboard-link').href = 'student-dashboard.html';
                                }
                            }
                        }).catch(error => {
                            console.error("Error checking user role:", error);
                        });
                        
                        // Initialize the assessment form
                        initializeAssessment();
                    } else {
                        // Only redirect if we previously had a user and now don't
                        if (currentUser) {
                            alert("Your session has expired. Please log in again.");
                            window.location.href = 'login.html';
                        }
                    }
                });
                
                // Clean up the observer when the page is unloaded
                window.addEventListener('beforeunload', () => unsubscribe());
            });
            
            // Logout functionality
            document.getElementById('logout-link').addEventListener('click', function(e) {
                e.preventDefault();
                
                // Save draft before logging out
                saveAssessmentDraft().then(() => {
                    signOut(auth).then(() => {
                        // Sign-out successful
                        window.location.href = 'login.html';
                    }).catch((error) => {
                        // An error happened
                        console.error("Error signing out:", error);
                    });
                });
            });
        });
        
        // Initialize assessment
        function initializeAssessment() {
            // Set up tab switching
            setupTabs();
            
            // Set up navigation buttons
            setupNavigation();
            
            // Set up budget item form
            setupBudgetItemForm();
            
            // Set up actuals form
            setupActualsForm();
            
            // Set up variance analysis
            setupVarianceAnalysis();
            
            // Set up recommendations
            setupRecommendations();
            
            // Set up save draft button
            document.getElementById('save-draft').addEventListener('click', function() {
                saveAssessmentDraft().then(() => {
                    alert('Draft saved successfully!');
                });
            });
            
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('assessment-date').value = today;
            
            // Load saved draft
            loadSavedDraft();
            
            // Set up auto-save
            setupAutoSave();
            
            // Set up session heartbeat
            setupSessionHeartbeat();
            
            // Set up form change tracking
            setupFormChangeTracking();
        }
        
        // Set up tab switching
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Save current state before switching tabs
                    saveAssessmentDraft();
                    
                    // Deactivate all tabs
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Activate the selected tab
                    const tabId = this.getAttribute('data-tab');
                    this.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                    
                    // Update progress steps
                    updateProgressSteps(tabId);
                });
            });
        }
        
        // Update progress steps
        function updateProgressSteps(currentTabId) {
            const stepMap = {
                'student-info': 'step1',
                'budget-creation': 'step2',
                'actual-results': 'step3',
                'variance-analysis': 'step4',
                'recommendations': 'step5',
                'final-report': 'step6'
            };
            
            const currentStepId = stepMap[currentTabId];
            const steps = document.querySelectorAll('.progress-step');
            
            steps.forEach(step => {
                step.classList.remove('active');
                step.classList.remove('completed');
            });
            
            // Mark current step as active
            document.getElementById(currentStepId).classList.add('active');
            
            // Mark previous steps as completed
            const stepIds = Object.values(stepMap);
            const currentIndex = stepIds.indexOf(currentStepId);
            
            for (let i = 0; i < currentIndex; i++) {
                document.getElementById(stepIds[i]).classList.add('completed');
            }
        }
        
        // Set up navigation buttons
        function setupNavigation() {
            // Student Info -> Budget Creation
            document.getElementById('next-to-budget').addEventListener('click', function() {
                if (validateStudentInfo()) {
                    switchToTab('budget-creation');
                }
            });
            
            // Budget Creation -> Student Info
            document.getElementById('back-to-student').addEventListener('click', function() {
                switchToTab('student-info');
            });
            
            // Budget Creation -> Actual Results
            document.getElementById('next-to-actuals').addEventListener('click', function() {
                if (validateBudgetCreation()) {
                    updateActualsTable();
                    switchToTab('actual-results');
                }
            });
            
            // Actual Results -> Budget Creation
            document.getElementById('back-to-budget').addEventListener('click', function() {
                switchToTab('budget-creation');
            });
            
            // Actual Results -> Variance Analysis
            document.getElementById('next-to-variance').addEventListener('click', function() {
                if (validateActualResults()) {
                    updateVarianceTable();
                    switchToTab('variance-analysis');
                }
            });
            
            // Variance Analysis -> Actual Results
            document.getElementById('back-to-actuals').addEventListener('click', function() {
                switchToTab('actual-results');
            });
            
            // Variance Analysis -> Recommendations
            document.getElementById('next-to-recommendations').addEventListener('click', function() {
                if (validateVarianceAnalysis()) {
                    updateRecommendationsList();
                    switchToTab('recommendations');
                }
            });
            
            // Recommendations -> Variance Analysis
            document.getElementById('back-to-variance').addEventListener('click', function() {
                switchToTab('variance-analysis');
            });
            
            // Recommendations -> Final Report
            document.getElementById('next-to-report').addEventListener('click', function() {
                if (validateRecommendations()) {
                    switchToTab('final-report');
                }
            });
            
            // Final Report -> Recommendations
            document.getElementById('back-to-recommendations').addEventListener('click', function() {
                switchToTab('recommendations');
            });
            
            // Submit Assessment
            document.getElementById('submit-assessment').addEventListener('click', function() {
                if (validateFinalReport()) {
                    submitAssessment();
                }
            });
        }
        
        // Switch to tab
        function switchToTab(tabId) {
            // Deactivate all tabs
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Activate the selected tab
            const tabButton = document.querySelector(`.tab-button[data-tab="${tabId}"]`);
            tabButton.classList.add('active');
            document.getElementById(tabId).classList.add('active');
            
            // Update progress steps
            updateProgressSteps(tabId);
        }
        
        // Set up budget item form
        function setupBudgetItemForm() {
            // Populate subcategories based on category selection
            document.getElementById('item-category').addEventListener('change', function() {
                const category = this.value;
                const subcategorySelect = document.getElementById('item-subcategory');
                
                // Clear existing options
                subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
                
                // Add new options based on category
                if (category === 'income') {
                    const incomeSubcategories = [
                        'Crop Sales', 'Livestock Sales', 'Milk Sales', 'Wool Sales',
                        'Government Subsidies', 'Rental Income', 'Other Income'
                    ];
                    
                    incomeSubcategories.forEach(subcategory => {
                        const option = document.createElement('option');
                        option.value = subcategory.toLowerCase().replace(/\s+/g, '-');
                        option.textContent = subcategory;
                        subcategorySelect.appendChild(option);
                    });
                } else if (category === 'expense') {
                    const expenseSubcategories = [
                        'Seeds', 'Fertilizers', 'Pesticides', 'Feed', 'Veterinary',
                        'Fuel', 'Electricity', 'Water', 'Labor', 'Equipment Maintenance',
                        'Land Lease', 'Insurance', 'Interest', 'Depreciation', 'Other Expenses'
                    ];
                    
                    expenseSubcategories.forEach(subcategory => {
                        const option = document.createElement('option');
                        option.value = subcategory.toLowerCase().replace(/\s+/g, '-');
                        option.textContent = subcategory;
                        subcategorySelect.appendChild(option);
                    });
                }
            });
            
            // Add budget item
            document.getElementById('add-budget-item').addEventListener('click', function() {
                addBudgetItem();
            });
        }
        
        // Add budget item
        function addBudgetItem() {
            const itemName = document.getElementById('item-name').value;
            const itemCategory = document.getElementById('item-category').value;
            const itemSubcategory = document.getElementById('item-subcategory').value;
            const itemAmount = parseFloat(document.getElementById('item-amount').value);
            const itemNotes = document.getElementById('item-notes').value;
            
            // Validate inputs
            if (!itemName || !itemCategory || !itemSubcategory || isNaN(itemAmount)) {
                alert('Please fill in all required fields.');
                return;
            }
            
            // Create unique ID for the item
            const itemId = 'item_' + Date.now();
            
            // Add to budget items array
            const newItem = {
                id: itemId,
                name: itemName,
                category: itemCategory,
                subcategory: itemSubcategory,
                subcategoryText: document.getElementById('item-subcategory').options[
                    document.getElementById('item-subcategory').selectedIndex
                ].text,
                amount: itemAmount,
                notes: itemNotes
            };
            
            budgetItems.push(newItem);
            
            // Update the table
            updateBudgetItemsTable();
            
            // Clear the form
            document.getElementById('item-name').value = '';
            document.getElementById('item-amount').value = '';
            document.getElementById('item-notes').value = '';
            document.getElementById('item-name').focus();
            
            // Update budget summary
            updateBudgetSummary();
        }
        
        // Update budget items table
        function updateBudgetItemsTable() {
            const tableBody = document.getElementById('budget-items-body');
            tableBody.innerHTML = '';
            
            budgetItems.forEach(item => {
                const row = document.createElement('tr');
                row.setAttribute('data-id', item.id);
                
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.category === 'income' ? 'Income' : 'Expense'}</td>
                    <td>${item.subcategoryText}</td>
                    <td>${formatCurrency(item.amount)}</td>
                    <td>${item.notes}</td>
                    <td>
                        <button class="btn-small btn-remove" onclick="removeBudgetItem('${item.id}')">Remove</button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // Remove budget item
        window.removeBudgetItem = function(itemId) {
            // Remove from array
            budgetItems = budgetItems.filter(item => item.id !== itemId);
            
            // Update the table
            updateBudgetItemsTable();
            
            // Update budget summary
            updateBudgetSummary();
        };
        
        // Update budget summary
        function updateBudgetSummary() {
            let totalIncome = 0;
            let totalExpenses = 0;
            
            budgetItems.forEach(item => {
                if (item.category === 'income') {
                    totalIncome += item.amount;
                } else {
                    totalExpenses += item.amount;
                }
            });
            
            const netResult = totalIncome - totalExpenses;
            
            document.getElementById('total-income').textContent = formatCurrency(totalIncome);
            document.getElementById('total-expenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('net-result').textContent = formatCurrency(netResult);
            
            // Add color coding for net result
            const netResultElement = document.getElementById('net-result');
            if (netResult > 0) {
                netResultElement.classList.add('positive');
                netResultElement.classList.remove('negative');
            } else if (netResult < 0) {
                netResultElement.classList.add('negative');
                netResultElement.classList.remove('positive');
            } else {
                netResultElement.classList.remove('positive');
                netResultElement.classList.remove('negative');
            }
        }
        
        // Set up actuals form
        function setupActualsForm() {
            // This will be populated when navigating to the actuals tab
        }
        
        // Update actuals table
        function updateActualsTable() {
            const tableBody = document.getElementById('actuals-body');
            tableBody.innerHTML = '';
            
            budgetItems.forEach(item => {
                const row = document.createElement('tr');
                row.setAttribute('data-id', item.id);
                
                // Calculate variance if actual amount exists
                const actualAmount = item.actual !== undefined ? item.actual : 0;
                const variance = item.category === 'income' 
                    ? actualAmount - item.amount 
                    : item.amount - actualAmount;
                
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.category === 'income' ? 'Income' : 'Expense'}</td>
                    <td>${formatCurrency(item.amount)}</td>
                    <td>
                        <input type="number" class="actual-amount" data-id="${item.id}" 
                            value="${actualAmount}" min="0" step="0.01">
                    </td>
                    <td class="${variance >= 0 ? 'positive-variance' : 'negative-variance'}">
                        ${formatCurrency(variance)}
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Add event listeners to actual amount inputs
            document.querySelectorAll('.actual-amount').forEach(input => {
                input.addEventListener('change', function() {
                    const itemId = this.getAttribute('data-id');
                    const actualAmount = parseFloat(this.value) || 0;
                    
                    // Update the budget item
                    const item = budgetItems.find(item => item.id === itemId);
                    if (item) {
                        item.actual = actualAmount;
                        
                        // Update variance
                        const variance = item.category === 'income' 
                            ? actualAmount - item.amount 
                            : item.amount - actualAmount;
                        
                        const varianceCell = this.parentElement.nextElementSibling;
                        varianceCell.textContent = formatCurrency(variance);
                        varianceCell.className = variance >= 0 ? 'positive-variance' : 'negative-variance';
                        
                        // Update actuals summary
                        updateActualsSummary();
                    }
                });
            });
            
            // Update actuals summary
            updateActualsSummary();
        }
        
        // Update actuals summary
        function updateActualsSummary() {
            let totalIncome = 0;
            let totalExpenses = 0;
            
            budgetItems.forEach(item => {
                if (item.category === 'income') {
                    totalIncome += item.actual !== undefined ? item.actual : 0;
                } else {
                    totalExpenses += item.actual !== undefined ? item.actual : 0;
                }
            });
            
            const netResult = totalIncome - totalExpenses;
            
            document.getElementById('actual-income').textContent = formatCurrency(totalIncome);
            document.getElementById('actual-expenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('actual-net-result').textContent = formatCurrency(netResult);
            
            // Add color coding for net result
            const netResultElement = document.getElementById('actual-net-result');
            if (netResult > 0) {
                netResultElement.classList.add('positive');
                netResultElement.classList.remove('negative');
            } else if (netResult < 0) {
                netResultElement.classList.add('negative');
                netResultElement.classList.remove('positive');
            } else {
                netResultElement.classList.remove('positive');
                netResultElement.classList.remove('negative');
            }
        }
        
        // Set up variance analysis
        function setupVarianceAnalysis() {
            // Save variance analysis
            document.getElementById('save-variance').addEventListener('click', function() {
                saveVarianceAnalysis();
            });
            
            // Cancel variance analysis
            document.getElementById('cancel-variance').addEventListener('click', function() {
                document.getElementById('variance-form').style.display = 'none';
            });
        }
        
        // Update variance table
        function updateVarianceTable() {
            const tableBody = document.getElementById('variance-body');
            tableBody.innerHTML = '';
            
            budgetItems.forEach(item => {
                // Calculate variance
                const actualAmount = item.actual !== undefined ? item.actual : 0;
                const variance = item.category === 'income' 
                    ? actualAmount - item.amount 
                    : item.amount - actualAmount;
                
                // Calculate variance percentage
                const baseAmount = item.amount > 0 ? item.amount : 1; // Avoid division by zero
                const variancePercent = (variance / baseAmount) * 100;
                
                // Only show significant variances (> 5%)
                if (Math.abs(variancePercent) >= 5) {
                    const row = document.createElement('tr');
                    row.setAttribute('data-id', item.id);
                    
                    // Check if this item has a variance analysis
                    const hasAnalysis = varianceAnalyses.some(analysis => analysis.itemId === item.id);
                    
                    row.innerHTML = `
                        <td>${item.name}</td>
                        <td>${formatCurrency(item.amount)}</td>
                        <td>${formatCurrency(actualAmount)}</td>
                        <td class="${variance >= 0 ? 'positive-variance' : 'negative-variance'}">
                            ${formatCurrency(variance)}
                        </td>
                        <td class="${variance >= 0 ? 'positive-variance' : 'negative-variance'}">
                            ${variancePercent.toFixed(2)}%
                        </td>
                        <td>
                            ${hasAnalysis ? 
                                `<button class="btn-small" onclick="viewVarianceAnalysis('${item.id}')">View</button>` :
                                `<button class="btn-small" onclick="analyzeVariance('${item.id}')">Analyze</button>`
                            }
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                }
            });
        }
        
        // Analyze variance
        window.analyzeVariance = function(itemId) {
            const item = budgetItems.find(item => item.id === itemId);
            if (!item) return;
            
            // Set current variance item
            currentVarianceItemId = itemId;
            
            // Show the variance form
            document.getElementById('variance-form').style.display = 'block';
            document.getElementById('variance-item-name').textContent = item.name;
            
            // Clear form
            document.getElementById('variance-cause').value = '';
            document.getElementById('variance-explanation').value = '';
        };
        
        // View variance analysis
        window.viewVarianceAnalysis = function(itemId) {
            const analysis = varianceAnalyses.find(analysis => analysis.itemId === itemId);
            if (!analysis) return;
            
            // Set current variance item
            currentVarianceItemId = itemId;
            
            // Show the variance form
            document.getElementById('variance-form').style.display = 'block';
            
            const item = budgetItems.find(item => item.id === itemId);
            document.getElementById('variance-item-name').textContent = item ? item.name : 'Unknown Item';
            
            // Fill form with existing analysis
            document.getElementById('variance-cause').value = analysis.cause;
            document.getElementById('variance-explanation').value = analysis.explanation;
        };
        
        // Save variance analysis
        function saveVarianceAnalysis() {
            const cause = document.getElementById('variance-cause').value;
            const explanation = document.getElementById('variance-explanation').value;
            
            // Validate inputs
            if (!cause || !explanation) {
                alert('Please fill in all required fields.');
                return;
            }
            
            // Check if this item already has an analysis
            const existingIndex = varianceAnalyses.findIndex(analysis => analysis.itemId === currentVarianceItemId);
            
            if (existingIndex >= 0) {
                // Update existing analysis
                varianceAnalyses[existingIndex].cause = cause;
                varianceAnalyses[existingIndex].explanation = explanation;
            } else {
                // Add new analysis
                varianceAnalyses.push({
                    itemId: currentVarianceItemId,
                    cause: cause,
                    explanation: explanation
                });
            }
            
            // Hide the form
            document.getElementById('variance-form').style.display = 'none';
            
            // Update the table
            updateVarianceTable();
        }
        
        // Set up recommendations
        function setupRecommendations() {
            // Add recommendation
            document.getElementById('add-recommendation').addEventListener('click', function() {
                addRecommendation();
            });
        }
        
        // Add recommendation
        function addRecommendation() {
            const title = document.getElementById('recommendation-title').value;
            const details = document.getElementById('recommendation-details').value;
            
            // Validate inputs
            if (!title || !details) {
                alert('Please fill in all required fields.');
                return;
            }
            
            // Create unique ID for the recommendation
            const recommendationId = 'rec_' + Date.now();
            
            // Add to recommendations array
            recommendations.push({
                id: recommendationId,
                title: title,
                details: details
            });
            
            // Update the list
            updateRecommendationsList();
            
            // Clear the form
            document.getElementById('recommendation-title').value = '';
            document.getElementById('recommendation-details').value = '';
            document.getElementById('recommendation-title').focus();
        }
        
        // Update recommendations list
        function updateRecommendationsList() {
            const recommendationsList = document.getElementById('recommendations-list');
            recommendationsList.innerHTML = '';
            
            if (recommendations.length === 0) {
                recommendationsList.innerHTML = '<p>No recommendations added yet.</p>';
                return;
            }
            
            recommendations.forEach(recommendation => {
                const recommendationElement = document.createElement('div');
                recommendationElement.className = 'recommendation-item';
                recommendationElement.setAttribute('data-id', recommendation.id);
                
                recommendationElement.innerHTML = `
                    <h4>${recommendation.title}</h4>
                    <p>${recommendation.details}</p>
                    <button class="btn-small btn-remove" onclick="removeRecommendation('${recommendation.id}')">Remove</button>
                `;
                
                recommendationsList.appendChild(recommendationElement);
            });
        }
        
        // Remove recommendation
        window.removeRecommendation = function(recommendationId) {
            // Remove from array
            recommendations = recommendations.filter(recommendation => recommendation.id !== recommendationId);
            
            // Update the list
            updateRecommendationsList();
        };
        
        // Validate student info
        function validateStudentInfo() {
            const studentName = document.getElementById('student-name').value;
            const studentId = document.getElementById('student-id').value;
            const assessmentDate = document.getElementById('assessment-date').value;
            
            if (!studentName || !studentId || !assessmentDate) {
                alert('Please fill in all required fields.');
                return false;
            }
            
            return true;
        }
        
        // Validate budget creation
        function validateBudgetCreation() {
            if (budgetItems.length === 0) {
                alert('Please add at least one budget item.');
                return false;
            }
            
            // Check if there are both income and expense items
            const hasIncome = budgetItems.some(item => item.category === 'income');
            const hasExpense = budgetItems.some(item => item.category === 'expense');
            
            if (!hasIncome || !hasExpense) {
                alert('Please add at least one income item and one expense item.');
                return false;
            }
            
            return true;
        }
        
        // Validate actual results
        function validateActualResults() {
            // Check if all items have actual amounts
            const missingActuals = budgetItems.some(item => item.actual === undefined);
            
            if (missingActuals) {
                alert('Please enter actual amounts for all budget items.');
                return false;
            }
            
            return true;
        }
        
        // Validate variance analysis
        function validateVarianceAnalysis() {
            // Get significant variances
            const significantVariances = budgetItems.filter(item => {
                const actualAmount = item.actual !== undefined ? item.actual : 0;
                const variance = item.category === 'income' 
                    ? actualAmount - item.amount 
                    : item.amount - actualAmount;
                
                const baseAmount = item.amount > 0 ? item.amount : 1; // Avoid division by zero
                const variancePercent = (variance / baseAmount) * 100;
                
                return Math.abs(variancePercent) >= 5;
            });
            
            // Check if all significant variances have been analyzed
            const allAnalyzed = significantVariances.every(item => 
                varianceAnalyses.some(analysis => analysis.itemId === item.id)
            );
            
            if (!allAnalyzed) {
                alert('Please analyze all significant variances.');
                return false;
            }
            
            // Check if overall assessment is provided
            const overallAssessment = document.getElementById('overall-assessment').value;
            if (!overallAssessment) {
                alert('Please provide an overall assessment of the budget performance.');
                return false;
            }
            
            return true;
        }
        
        // Validate recommendations
        function validateRecommendations() {
            if (recommendations.length === 0) {
                alert('Please add at least one recommendation.');
                return false;
            }
            
            return true;
        }
        
        // Validate final report
        function validateFinalReport() {
            const finalReport = document.getElementById('final-report-text').value;
            
            if (!finalReport) {
                alert('Please provide a final report.');
                return false;
            }
            
            return true;
        }
        
        // Submit assessment
        async function submitAssessment() {
            try {
                // Show loading state
                const submitButton = document.getElementById('submit-assessment');
                const originalButtonText = submitButton.textContent;
                submitButton.disabled = true;
                submitButton.textContent = 'Submitting...';
                
                // Collect all assessment data
                const assessmentData = {
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    studentName: document.getElementById('student-name').value,
                    studentId: document.getElementById('student-id').value,
                    unitCode: document.getElementById('unit-code').value,
                    assessmentDate: document.getElementById('assessment-date').value,
                    farmType: document.getElementById('farm-type').value,
                    budgetPeriod: document.getElementById('budget-period').value,
                    budgetItems: budgetItems,
                    variances: varianceAnalyses,
                    overallAssessment: document.getElementById('overall-assessment').value,
                    recommendations: recommendations,
                    finalReport: document.getElementById('final-report-text').value,
                    status: 'submitted',
                    submittedAt: new Date(),
                    startDate: new Date(document.getElementById('assessment-date').value),
                    completionDate: new Date()
                };
                
                // Submit to Firebase
                const docRef = await addDoc(collection(db, "assessments"), assessmentData);
                console.log("Assessment saved with ID:", docRef.id);
                
                // Clear draft
                try {
                    const userRef = doc(db, "users", currentUser.uid);
                    const draftRef = doc(collection(userRef, "assessmentDrafts"), "currentDraft");
                    await deleteDoc(draftRef);
                } catch (error) {
                    console.error("Error deleting draft:", error);
                }
                
                // Clear localStorage
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('assessment_')) {
                        localStorage.removeItem(key);
                    }
                });
                
                // Show success message
                alert('Assessment submitted successfully!');
                
                // Redirect to dashboard
                window.location.href = document.getElementById('dashboard-link').href;
                
            } catch (error) {
                console.error("Error submitting assessment:", error);
                alert('Error submitting assessment: ' + error.message);
                
                // Reset button
                const submitButton = document.getElementById('submit-assessment');
                submitButton.disabled = false;
                submitButton.textContent = originalButtonText;
            }
        }
        
        // Save assessment draft
        async function saveAssessmentDraft() {
            if (!currentUser) return Promise.reject(new Error("Not authenticated"));
            
            try {
                // Collect all form data
                const formData = {
                    studentName: document.getElementById('student-name').value,
                    studentId: document.getElementById('student-id').value,
                    assessmentDate: document.getElementById('assessment-date').value,
                    farmType: document.getElementById('farm-type').value,
                    budgetPeriod: document.getElementById('budget-period').value,
                    budgetItems: budgetItems,
                    variances: varianceAnalyses,
                    overallAssessment: document.getElementById('overall-assessment').value,
                    recommendations: recommendations,
                    finalReport: document.getElementById('final-report-text').value,
                    lastUpdated: new Date()
                };
                
                // Save to Firestore
                const userRef = doc(db, "users", currentUser.uid);
                const draftRef = doc(collection(userRef, "assessmentDrafts"), "currentDraft");
                
                await setDoc(draftRef, formData);
                console.log("Draft saved");
                
                // Update save status
                lastSaveTime = new Date();
                document.getElementById('save-time').textContent = lastSaveTime.toLocaleTimeString();
                document.getElementById('save-status').style.display = 'block';
                
                // Also save to localStorage as backup
                localStorage.setItem('assessment_data', JSON.stringify(formData));
                
                return Promise.resolve();
            } catch (error) {
                console.error("Error saving draft:", error);
                return Promise.reject(error);
            }
        }
        
        // Load saved draft
        async function loadSavedDraft() {
            if (!currentUser) return;
            
            try {
                // Try to load from Firestore first
                const userRef = doc(db, "users", currentUser.uid);
                const draftRef = doc(collection(userRef, "assessmentDrafts"), "currentDraft");
                
                const docSnap = await getDoc(draftRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Populate form fields
                    if (data.studentName) document.getElementById('student-name').value = data.studentName;
                    if (data.studentId) document.getElementById('student-id').value = data.studentId;
                    if (data.assessmentDate) document.getElementById('assessment-date').value = data.assessmentDate;
                    if (data.farmType) document.getElementById('farm-type').value = data.farmType;
                    if (data.budgetPeriod) document.getElementById('budget-period').value = data.budgetPeriod;
                    
                    // Load budget items
                    if (data.budgetItems && Array.isArray(data.budgetItems)) {
                        budgetItems = data.budgetItems;
                        updateBudgetItemsTable();
                        updateBudgetSummary();
                    }
                    
                    // Load variance analyses
                    if (data.variances && Array.isArray(data.variances)) {
                        varianceAnalyses = data.variances;
                    }
                    
                    // Load overall assessment
                    if (data.overallAssessment) document.getElementById('overall-assessment').value = data.overallAssessment;
                    
                    // Load recommendations
                    if (data.recommendations && Array.isArray(data.recommendations)) {
                        recommendations = data.recommendations;
                        updateRecommendationsList();
                    }
                    
                    // Load final report
                    if (data.finalReport) document.getElementById('final-report-text').value = data.finalReport;
                    
                    // Update save status
                    if (data.lastUpdated) {
                        lastSaveTime = new Date(data.lastUpdated.seconds * 1000);
                        document.getElementById('save-time').textContent = lastSaveTime.toLocaleTimeString();
                        document.getElementById('save-status').style.display = 'block';
                    }
                    
                    console.log("Draft loaded from Firestore");
                } else {
                    // Fall back to localStorage
                    const savedData = localStorage.getItem('assessment_data');
                    if (savedData) {
                        const data = JSON.parse(savedData);
                        
                        // Populate form fields (same as above)
                        if (data.studentName) document.getElementById('student-name').value = data.studentName;
                        if (data.studentId) document.getElementById('student-id').value = data.studentId;
                        if (data.assessmentDate) document.getElementById('assessment-date').value = data.assessmentDate;
                        if (data.farmType) document.getElementById('farm-type').value = data.farmType;
                        if (data.budgetPeriod) document.getElementById('budget-period').value = data.budgetPeriod;
                        
                        // Load budget items
                        if (data.budgetItems && Array.isArray(data.budgetItems)) {
                            budgetItems = data.budgetItems;
                            updateBudgetItemsTable();
                            updateBudgetSummary();
                        }
                        
                        // Load variance analyses
                        if (data.variances && Array.isArray(data.variances)) {
                            varianceAnalyses = data.variances;
                        }
                        
                        // Load overall assessment
                        if (data.overallAssessment) document.getElementById('overall-assessment').value = data.overallAssessment;
                        
                        // Load recommendations
                        if (data.recommendations && Array.isArray(data.recommendations)) {
                            recommendations = data.recommendations;
                            updateRecommendationsList();
                        }
                        
                        // Load final report
                        if (data.finalReport) document.getElementById('final-report-text').value = data.finalReport;
                        
                        console.log("Draft loaded from localStorage");
                    } else {
                        // No saved draft found
                        console.log("No saved draft found");
                    }
                }
            } catch (error) {
                console.error("Error loading draft:", error);
            }
        }
        
        // Set up auto-save
        function setupAutoSave() {
            // Clear any existing timer
            if (autoSaveTimer) clearInterval(autoSaveTimer);
            
            // Set up auto-save every 30 seconds
            autoSaveTimer = setInterval(() => {
                if (currentUser) {
                    saveAssessmentDraft().catch(error => {
                        console.error("Auto-save error:", error);
                    });
                }
            }, 30000); // 30 seconds
        }
        
        // Set up session heartbeat
        function setupSessionHeartbeat() {
            // Send a heartbeat every 5 minutes to keep the session alive
            setInterval(() => {
                if (currentUser) {
                    // Refresh the token
                    currentUser.getIdToken(true)
                        .then(() => console.log("Session refreshed"))
                        .catch(error => console.error("Error refreshing session:", error));
                }
            }, 300000); // 5 minutes
        }
        
        // Set up form change tracking
        function setupFormChangeTracking() {
            // For all form elements
            document.querySelectorAll('input, textarea, select').forEach(input => {
                input.addEventListener('change', function() {
                    // Store the value in local storage as a backup
                    if (this.id) {
                        localStorage.setItem('assessment_' + this.id, this.value);
                    }
                });
            });
            
            // Add window focus handler for session recovery
            window.addEventListener('focus', function() {
                // When the window gets focus, check if we're still authenticated
                if (currentUser) {
                    currentUser.getIdToken(true)
                        .then(() => console.log("Session verified on window focus"))
                        .catch(error => {
                            console.error("Session error on window focus:", error);
                            // Try to refresh the page to recover the session
                            if (confirm("Your session may have expired. Would you like to refresh the page to reconnect?")) {
                                // Save form data to localStorage before refreshing
                                document.querySelectorAll('input, textarea, select').forEach(input => {
                                    if (input.id) {
                                        localStorage.setItem('assessment_' + input.id, input.value);
                                    }
                                });
                                
                                window.location.reload();
                            }
                        });
                }
            });
        }
        
        // Format currency
        function formatCurrency(amount) {
            return '$' + Number(amount).toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
    </script>
</body>
</html>