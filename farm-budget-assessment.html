<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Farm Budget Assessment - AHCBUS408 Budget Master</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="images/RIST Brandmark - Navy Circle.png" type="image/png">
    <style>
        /* Assessment-specific styles */
        .assessment-header {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .assessment-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .student-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .assessment-progress {
            display: flex;
            justify-content: space-between;
            margin: 30px 0;
            position: relative;
        }
        
        .assessment-progress::before {
            content: "";
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #e1e4e8;
            z-index: 1;
        }
        
        .progress-step {
            position: relative;
            z-index: 2;
            background-color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #e1e4e8;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .progress-step.active {
            border-color: #3498db;
            background-color: #3498db;
            color: white;
        }
        
        .progress-step.completed {
            border-color: #2ecc71;
            background-color: #2ecc71;
            color: white;
        }
        
        .progress-step .step-label {
            position: absolute;
            top: 35px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .tab-buttons {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #e1e4e8;
        }
        
        .tab-button {
            padding: 10px 20px;
            background-color: #f8f9fa;
            border: none;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
            cursor: pointer;
        }
        
        .tab-button.active {
            background-color: #3498db;
            color: white;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            background-color: white;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .budget-item-form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .budget-items-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .budget-items-table th,
        .budget-items-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e1e4e8;
        }
        
        .budget-items-table th {
            background-color: #f8f9fa;
        }
        
        .actuals-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .actuals-table th,
        .actuals-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e1e4e8;
        }
        
        .actuals-table th {
            background-color: #f8f9fa;
        }
        
        .variance-selection {
            margin-bottom: 30px;
        }
        
        .variance-item {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        
        .recommendation-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .recommendation-option {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
        }
        
        .recommendation-details {
            margin-top: 10px;
        }
        
        .error-input {
            border: 1px solid #dc3545 !important;
            background-color: #fff8f8 !important;
        }
        
        .feedback {
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .feedback.info {
            background-color: #e3f2fd;
            border: 1px solid #90caf9;
            color: #0d47a1;
        }
        
        .feedback.warning {
            background-color: #fff3e0;
            border: 1px solid #ffcc80;
            color: #e65100;
        }
        
        .feedback.error {
            background-color: #ffebee;
            border: 1px solid #ef9a9a;
            color: #b71c1c;
        }
        
        .feedback.success {
            background-color: #e8f5e9;
            border: 1px solid #a5d6a7;
            color: #1b5e20;
        }
        
        .positive-variance {
            color: #2ecc71;
        }
        
        .negative-variance {
            color: #e74c3c;
        }
        
        .neutral-variance {
            color: #7f8c8d;
        }
        
        .btn-group {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .student-info-grid,
            .budget-item-form {
                grid-template-columns: 1fr;
            }
            
            .assessment-progress {
                overflow-x: auto;
                padding-bottom: 10px;
            }
            
            .progress-step .step-label {
                font-size: 12px;
            }
            
            .tab-buttons {
                overflow-x: auto;
                white-space: nowrap;
                display: flex;
                padding-bottom: 5px;
            }
            
            .tab-button {
                flex: 0 0 auto;
            }
            
            .recommendation-options {
                grid-template-columns: 1fr;
            }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <script type="module">
        import { requireAuth, initAuth } from './js/auth.js';
        
        // Initialize authentication
        initAuth();
        
        // Ensure user is authenticated
        document.addEventListener('DOMContentLoaded', async () => {
          const user = await requireAuth();
          if (user) {
            // User is authenticated, continue with page initialization
            console.log("User authenticated:", user.email);
            // Initialize assessment functionality here
          }
        });
      </script>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo-container">
                    <img src="images/RIST - Primary Colour.jpg" alt="RIST - Rural Industries Skill Training" class="rist-logo">
                </div>
                <div class="title-container">
                    <h1>AHCBUS408 Budget Master</h1>
                    <p>Agricultural Budgeting Training Tool</p>
                </div>
                <div id="user-status" class="user-status">
                    <!-- Login status will be shown here -->
                </div>
            </div>
        </div>
    </header>
    <nav>
        <div class="container">
          <ul>
            <li><a href="index.html">Home</a></li>
            <li class="auth-required" style="display:none;"><a href="budget.html">Budget Simulator</a></li>
            <li class="auth-required" style="display:none;"><a href="farm-budget-assessment.html">Assessment</a></li>
            
            <!-- Student-specific navigation -->
            <li class="student-only" style="display:none;"><a href="student-dashboard.html">My Dashboard</a></li>
            <li class="student-only" style="display:none;"><a href="my-assessments.html">My Assessments</a></li>
            
            <!-- Trainer-specific navigation -->
            <li class="trainer-only" style="display:none;"><a href="trainer-dashboard.html">Trainer Dashboard</a></li>
            <li class="trainer-only" style="display:none;"><a href="review-assessments.html">Review Assessments</a></li>
            
            <!-- Authentication links -->
            <li id="login-nav-item"><a href="login.html">Login</a></li>
            <li id="logout-nav-item" style="display:none;"><a href="#" id="logout-link">Logout</a></li>
          </ul>
          <div id="user-status" class="user-status"></div>
        </div>
      </nav>

    <main class="container">
        <div class="assessment-header">
            <h2>Farm Budget Management Assessment</h2>
            <p>Apply your knowledge to create, monitor, analyse, and adjust a farm budget based on a comprehensive case scenario.</p>
            
            <div class="assessment-info">
                <div>
                    <strong>Unit Code:</strong> <span id="unit-code">AHCBUS408</span>
                </div>
                <div>
                    <strong>Unit Name:</strong> <span id="unit-name">Operate within a budget framework</span>
                </div>
                <div>
                    <strong>Duration:</strong> <span>120 minutes</span>
                </div>
                <div>
                    <strong>Format:</strong> <span>Multi-part Assessment</span>
                </div>
            </div>
        </div>
        
        <div id="loading-indicator" style="text-align: center; padding: 20px;">
            <p>Loading assessment...</p>
            <div class="spinner" style="border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #1a3a5f; animation: spin 1s linear infinite; margin: 20px auto;"></div>
        </div>
        
        <div id="assessment-content" style="display: none;">
            <div class="assessment-progress">
                <div class="progress-step active" data-step="1">
                    1
                    <span class="step-label">Setup</span>
                </div>
                <div class="progress-step" data-step="2">
                    2
                    <span class="step-label">Track Actuals</span>
                </div>
                <div class="progress-step" data-step="3">
                    3
                    <span class="step-label">Analyse Variances</span>
                </div>
                <div class="progress-step" data-step="4">
                    4
                    <span class="step-label">Make Adjustments</span>
                </div>
            </div>
            
            <div class="tab-buttons">
                <button class="tab-button active" data-tab="instructions">Instructions</button>
                <button class="tab-button" data-tab="budget-setup">Budget Setup</button>
                <button class="tab-button" data-tab="track-actuals">Track Actuals</button>
                <button class="tab-button" data-tab="variance-analysis">Variance Analysis</button>
                <button class="tab-button" data-tab="adjustments">Adjustments</button>
            </div>
            
            <div id="instructions" class="tab-content active">
                <h3>Assessment Instructions</h3>
                <p>Welcome to the Farm Budget Management Assessment. In this assessment, you will demonstrate your ability to create, monitor, analyse, and adjust a farm budget.</p>
                
                <h4>Scenario</h4>
                <p>You are the manager of Green Valley Farm, a mixed farming operation that produces crops (wheat, corn, and soybeans) and raises livestock (beef cattle). The farm owner has asked you to prepare a quarterly budget, track actual performance, analyse variances, and make recommendations for improvements.</p>
                
                <h4>Assessment Tasks</h4>
                <ol>
                    <li><strong>Budget Setup:</strong> Create a quarterly budget for the farm with appropriate income and expense categories.</li>
                    <li><strong>Track Actuals:</strong> Record the actual income and expenses for the quarter.</li>
                    <li><strong>Variance Analysis:</strong> Analyse the variances between budgeted and actual figures.</li>
                    <li><strong>Adjustments:</strong> Make recommendations for improving budget performance in future periods.</li>
                </ol>
                
                <h4>Student Information</h4>
                <p>Please provide your details below:</p>
                
                <div class="student-info-grid">
                    <div class="form-group">
                        <label for="student-name">Student Name:</label>
                        <input type="text" id="student-name" placeholder="Enter your full name">
                    </div>
                    
                    <div class="form-group">
                        <label for="student-id">Student ID:</label>
                        <input type="text" id="student-id" placeholder="Enter your student ID">
                    </div>
                    
                    <div class="form-group">
                        <label for="start-date">Start Date:</label>
                        <input type="date" id="start-date">
                    </div>
                    
                    <div class="form-group">
                        <label for="completion-date">Completion Date:</label>
                        <input type="date" id="completion-date" disabled>
                    </div>
                </div>
                
                <button class="btn" onclick="validateStudentInfo() && nextTab('budget-setup')">Start Assessment</button>
            </div>
            
            <div id="budget-setup" class="tab-content">
                <h3>Budget Setup</h3>
                <p>Create a quarterly budget for Green Valley Farm by adding income and expense items. You should include all major income sources and expense categories relevant to a mixed farming operation.</p>
                
                <div class="budget-item-form">
                    <div class="form-group">
                        <label for="item-name">Item Name:</label>
                        <input type="text" id="item-name" placeholder="e.g., Wheat Sales, Feed Costs">
                    </div>
                    
                    <div class="form-group">
                        <label for="item-category">Category:</label>
                        <select id="item-category">
                            <option value="">-- Select Category --</option>
                            <option value="income">Income</option>
                            <option value="expense">Expense</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="item-subcategory">Subcategory:</label>
                        <select id="item-subcategory" disabled>
                            <option value="">-- Select Subcategory --</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="item-amount">Budgeted Amount ($):</label>
                        <input type="number" id="item-amount" placeholder="Enter amount" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="item-notes">Notes:</label>
                        <input type="text" id="item-notes" placeholder="Optional notes">
                    </div>
                    
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <button class="btn" id="add-budget-item">Add Item</button>
                    </div>
                </div>
                
                <h4>Budget Items</h4>
                <table class="budget-items-table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Category</th>
                            <th>Subcategory</th>
                            <th>Budgeted Amount</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="budget-items-table-body">
                        <!-- Budget items will be added here -->
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3"><strong>Total Income:</strong></td>
                            <td id="total-income">$0</td>
                            <td colspan="2"></td>
                        </tr>
                        <tr>
                            <td colspan="3"><strong>Total Expenses:</strong></td>
                            <td id="total-expenses">$0</td>
                            <td colspan="2"></td>
                        </tr>
                        <tr>
                            <td colspan="3"><strong>Net Profit/Loss:</strong></td>
                            <td id="net-profit">$0</td>
                            <td colspan="2"></td>
                        </tr>
                    </tfoot>
                </table>
                
                <div id="budget-setup-feedback" class="feedback info">
                    <p>Your budget should include at least 5 items, with both income and expense categories. Consider including key farm income sources (crops, livestock) and major expense categories (seeds, fertiliser, labour, etc.).</p>
                </div>
                
                <div class="btn-group">
                    <button class="btn" onclick="prevTab('instructions')">Previous</button>
                    <button class="btn btn-primary" onclick="validateBudgetSetup()">Next</button>
                </div>
            </div>
            
            <div id="track-actuals" class="tab-content">
                <h3>Track Actuals</h3>
                <p>Now that you have set up your budget, it's time to record the actual income and expenses for the quarter. Enter the actual amounts for each budget item.</p>
                
                <table class="actuals-table" id="actuals-table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Category</th>
                            <th>Subcategory</th>
                            <th>Budgeted Amount</th>
                            <th>Actual Amount</th>
                            <th>Variance</th>
                        </tr>
                    </thead>
                    <tbody id="actuals-table-body">
                        <!-- Actuals will be added here -->
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3"><strong>Total Income:</strong></td>
                            <td id="total-income-budgeted">$0</td>
                            <td id="total-income-actual">$0</td>
                            <td id="total-income-variance">$0</td>
                        </tr>
                        <tr>
                            <td colspan="3"><strong>Total Expenses:</strong></td>
                            <td id="total-expenses-budgeted">$0</td>
                            <td id="total-expenses-actual">$0</td>
                            <td id="total-expenses-variance">$0</td>
                        </tr>
                        <tr>
                            <td colspan="3"><strong>Net Profit/Loss:</strong></td>
                            <td id="net-profit-budgeted">$0</td>
                            <td id="net-profit-actual">$0</td>
                            <td id="net-profit-variance">$0</td>
                        </tr>
                    </tfoot>
                </table>
                
                <div id="track-actuals-feedback" class="feedback info">
                    <p>Enter the actual amounts for each budget item. The variance will be calculated automatically. Consider what factors might have caused any significant variances.</p>
                </div>
                
                <div class="btn-group">
                    <button class="btn" onclick="prevTab('budget-setup')">Previous</button>
                    <button class="btn btn-primary" onclick="validateActuals()">Next</button>
                </div>
            </div>
            
            <div id="variance-analysis" class="tab-content">
                <h3>Variance Analysis</h3>
                <p>Analyse the variances between your budgeted and actual figures. Identify the most significant variances and explain their causes.</p>
                
                <h4>Variance Summary</h4>
                <div id="variance-summary" class="feedback info">
                    <!-- Variance summary will be added here -->
                </div>
                
                <h4>Significant Variances</h4>
                <p>Select the three most significant variances and analyse their causes:</p>
                
                <div class="variance-selection">
                    <div class="variance-item">
                        <div class="form-group">
                            <label for="variance-1">Most Significant Variance:</label>
                            <select id="variance-1">
                                <option value="">-- Select Item --</option>
                                <!-- Options will be added dynamically -->
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="variance-1-cause">Cause of Variance:</label>
                            <select id="variance-1-cause">
                                <option value="">-- Select Cause --</option>
                                <option value="price-change">Price Change</option>
                                <option value="volume-change">Volume/Quantity Change</option>
                                <option value="timing-difference">Timing Difference</option>
                                <option value="unexpected-event">Unexpected Event</option>
                                <option value="estimation-error">Estimation Error</option>
                                <option value="efficiency-change">Efficiency Change</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="variance-1-explanation">Explanation:</label>
                            <textarea id="variance-1-explanation" rows="3" placeholder="Explain the cause of this variance and its impact"></textarea>
                        </div>
                    </div>
                    
                    <div class="variance-item">
                        <div class="form-group">
                            <label for="variance-2">Second Most Significant Variance:</label>
                            <select id="variance-2">
                                <option value="">-- Select Item --</option>
                                <!-- Options will be added dynamically -->
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="variance-2-cause">Cause of Variance:</label>
                            <select id="variance-2-cause">
                                <option value="">-- Select Cause --</option>
                                <option value="price-change">Price Change</option>
                                <option value="volume-change">Volume/Quantity Change</option>
                                <option value="timing-difference">Timing Difference</option>
                                <option value="unexpected-event">Unexpected Event</option>
                                <option value="estimation-error">Estimation Error</option>
                                <option value="efficiency-change">Efficiency Change</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="variance-2-explanation">Explanation:</label>
                            <textarea id="variance-2-explanation" rows="3" placeholder="Explain the cause of this variance and its impact"></textarea>
                        </div>
                    </div>
                    
                    <div class="variance-item">
                        <div class="form-group">
                            <label for="variance-3">Third Most Significant Variance:</label>
                            <select id="variance-3">
                                <option value="">-- Select Item --</option>
                                <!-- Options will be added dynamically -->
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="variance-3-cause">Cause of Variance:</label>
                            <select id="variance-3-cause">
                                <option value="">-- Select Cause --</option>
                                <option value="price-change">Price Change</option>
                                <option value="volume-change">Volume/Quantity Change</option>
                                <option value="timing-difference">Timing Difference</option>
                                <option value="unexpected-event">Unexpected Event</option>
                                <option value="estimation-error">Estimation Error</option>
                                <option value="efficiency-change">Efficiency Change</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="variance-3-explanation">Explanation:</label>
                            <textarea id="variance-3-explanation" rows="3" placeholder="Explain the cause of this variance and its impact"></textarea>
                        </div>
                    </div>
                </div>
                
                <h4>Overall Budget Performance Assessment</h4>
                <div class="form-group">
                    <label for="overall-assessment">Provide an overall assessment of the budget performance:</label>
                    <textarea id="overall-assessment" rows="5" placeholder="Assess the overall budget performance, considering both positive and negative variances and their impact on the farm's financial position"></textarea>
                </div>
                
                <div id="variance-analysis-feedback" class="feedback info">
                    <p>Analyse the most significant variances and provide thoughtful explanations for their causes. Your analysis should consider both internal and external factors that may have affected the budget performance.</p>
                </div>
                
                <div class="btn-group">
                    <button class="btn" onclick="prevTab('track-actuals')">Previous</button>
                    <button class="btn btn-primary" onclick="validateVarianceAnalysis()">Next</button>
                </div>
            </div>
            
            <div id="adjustments" class="tab-content">
                <h3>Budget Adjustments and Recommendations</h3>
                <p>Based on your variance analysis, provide recommendations for improving budget performance in future periods.</p>
                
                <h4>Recommendations</h4>
                <div class="recommendation-options">
                    <div class="recommendation-option">
                        <h5 id="recommendation-1-title">Recommendation 1</h5>
                        <div class="form-group">
                            <label for="recommendation-1-details">Details:</label>
                            <textarea id="recommendation-1-details" rows="4" placeholder="Provide specific details for this recommendation"></textarea>
                        </div>
                    </div>
                    
                    <div class="recommendation-option">
                        <h5 id="recommendation-2-title">Recommendation 2</h5>
                        <div class="form-group">
                            <label for="recommendation-2-details">Details:</label>
                            <textarea id="recommendation-2-details" rows="4" placeholder="Provide specific details for this recommendation"></textarea>
                        </div>
                    </div>
                    
                    <div class="recommendation-option">
                        <h5 id="recommendation-3-title">Recommendation 3</h5>
                        <div class="form-group">
                            <label for="recommendation-3-details">Details:</label>
                            <textarea id="recommendation-3-details" rows="4" placeholder="Provide specific details for this recommendation"></textarea>
                        </div>
                    </div>
                </div>
                
                <h4>Final Budget Report</h4>
                <div class="form-group">
                    <label for="final-report">Prepare a final budget report for the farm owner:</label>
                    <textarea id="final-report" rows="8" placeholder="Summarise the budget performance, key variances, and your recommendations for future budget periods. This should be a comprehensive report that the farm owner can use to make informed decisions."></textarea>
                </div>
                
                <div id="adjustments-feedback" class="feedback info">
                    <p>Your recommendations should be specific, actionable, and directly related to the variances you identified. The final report should provide a clear summary of the budget performance and a path forward for improved budget management.</p>
                </div>
                
                <div class="btn-group">
                    <button class="btn" onclick="prevTab('variance-analysis')">Previous</button>
                    <button class="btn btn-success" onclick="submitAssessment()">Submit Assessment</button>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <img src="images/RIST Brandmark - Navy Circle.png" alt="RIST" class="rist-logo-footer">
                </div>
                <div class="footer-info">
                    <p>&copy; 2025 RIST - Rural Industries Skill Training</p>
                    <p>AHCBUS408 Budget Master</p>
                </div>
                <div class="footer-contact">
                    <p>Contact: <a href="mailto:info@rist.com.au">info@rist.com.au</a></p>
                </div>
            </div>
        </div>
    </footer>
    
    <script type="module">
        import { auth, onAuthStateChanged, signOut, db, doc, getDoc, collection, addDoc } from './js/firebase-config.js';
        
        // Global variables for module scope
        let budgetItems = [];
        let incomeSubcategories = [];
        let expenseSubcategories = [];
        
        // Check authentication status when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM loaded, checking authentication");
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // User is signed in
                    console.log("User is signed in:", user.email);
                    document.getElementById('login-nav-item').style.display = 'none';
                    document.getElementById('dashboard-nav-item').style.display = 'inline-block';
                    document.getElementById('logout-nav-item').style.display = 'inline-block';
                    document.getElementById('user-status').innerHTML = 'Logged in as: ' + user.email;
                    
                    // Check user role for dashboard link
                    try {
                        const userDoc = await getDoc(doc(db, 'users', user.uid));
                        if (userDoc.exists()) {
                            const userData = userDoc.data();
                            const role = userData.role;
                            
                            if (role === 'trainer') {
                                document.getElementById('dashboard-link').href = 'trainer-dashboard.html';
                            } else {
                                document.getElementById('dashboard-link').href = 'student-dashboard.html';
                            }
                            
                            // Prefill student name field if it exists
                            if (document.getElementById('student-name') && userData.fullName) {
                                document.getElementById('student-name').value = userData.fullName;
                            }
                        }
                    } catch (error) {
                        console.error("Error checking user role:", error);
                    }
                    
                    // Initialize the page
                    initializePage();
                    
                    // Hide loading indicator and show content
                    document.getElementById('loading-indicator').style.display = 'none';
                    document.getElementById('assessment-content').style.display = 'block';
                } else {
                    // User is not signed in - redirect to login page
                    console.log("User is not signed in, redirecting to login");
                    window.location.href = 'login.html';
                }
            });
            
            // Logout functionality
            document.getElementById('logout-link').addEventListener('click', function(e) {
                e.preventDefault();
                signOut(auth).then(() => {
                    // Sign-out successful
                    window.location.href = 'login.html';
                }).catch((error) => {
                    // An error happened
                    console.error("Error signing out:", error);
                });
            });
        });
        
        // Function to initialize the page
        function initializePage() {
            console.log("Initialising assessment page");
            
            // Set up subcategory options
            incomeSubcategories = [
                { value: 'crop-sales', label: 'Crop Sales' },
                { value: 'livestock-sales', label: 'Livestock Sales' },
                { value: 'government-payments', label: 'Government Payments' },
                { value: 'custom-work', label: 'Custom Work' },
                { value: 'other-income', label: 'Other Income' }
            ];
            
            expenseSubcategories = [
                { value: 'seeds-plants', label: 'Seeds & Plants' },
                { value: 'fertiliser-chemicals', label: 'Fertiliser & Chemicals' },
                { value: 'feed', label: 'Animal Feed' },
                { value: 'veterinary', label: 'Veterinary & Medicine' },
                { value: 'fuel', label: 'Fuel & Utilities' },
                { value: 'repairs', label: 'Repairs & Maintenance' },
                { value: 'labour-wages', label: 'Labour & Wages' },
                { value: 'rent-lease', label: 'Rent & Leases' },
                { value: 'insurance', label: 'Insurance' },
                { value: 'taxes', label: 'Taxes' },
                { value: 'interest', label: 'Interest' },
                { value: 'other-expenses', label: 'Other Expenses' }
            ];
            
            // Set today's date as the default start date
            document.getElementById('start-date').valueAsDate = new Date();
            
            // Set up event listeners
            setupEventListeners();
            
            // Set up tab navigation
            setupTabNavigation();
        }
        
        // Function to set up event listeners
        function setupEventListeners() {
            // Category change event
            document.getElementById('item-category').addEventListener('change', updateSubcategories);
            
            // Add budget item button
            document.getElementById('add-budget-item').addEventListener('click', addBudgetItem);
        }
        
        // Function to set up tab navigation
        function setupTabNavigation() {
            const tabButtons = document.querySelectorAll('.tab-button');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    openTab(tabId);
                });
            });
        }
        
        // Function to update subcategories based on selected category
        function updateSubcategories() {
            const categorySelect = document.getElementById('item-category');
            const subcategorySelect = document.getElementById('item-subcategory');
            
            // Clear existing options
            subcategorySelect.innerHTML = '<option value="">-- Select Subcategory --</option>';
            
            // Get selected category
            const selectedCategory = categorySelect.value;
            
            if (selectedCategory === 'income') {
                // Add income subcategories
                incomeSubcategories.forEach(subcategory => {
                    const option = document.createElement('option');
                    option.value = subcategory.value;
                    option.textContent = subcategory.label;
                    subcategorySelect.appendChild(option);
                });
                subcategorySelect.disabled = false;
            } else if (selectedCategory === 'expense') {
                // Add expense subcategories
                expenseSubcategories.forEach(subcategory => {
                    const option = document.createElement('option');
                    option.value = subcategory.value;
                    option.textContent = subcategory.label;
                    subcategorySelect.appendChild(option);
                });
                subcategorySelect.disabled = false;
            } else {
                subcategorySelect.disabled = true;
            }
        }
        
        // Function to add a budget item
        function addBudgetItem() {
            // Get input values
            const itemName = document.getElementById('item-name').value.trim();
            const category = document.getElementById('item-category').value;
            const subcategorySelect = document.getElementById('item-subcategory');
            const subcategory = subcategorySelect.value;
            const subcategoryText = subcategorySelect.options[subcategorySelect.selectedIndex]?.text || '';
            const amount = parseFloat(document.getElementById('item-amount').value) || 0;
            const notes = document.getElementById('item-notes').value.trim();
            
            // Validate inputs
            if (!itemName) {
                alert('Please enter an item name.');
                return;
            }
            
            if (!category) {
                alert('Please select a category.');
                return;
            }
            
            if (!subcategory) {
                alert('Please select a subcategory.');
                return;
            }
            
            if (amount <= 0) {
                alert('Please enter a valid amount greater than zero.');
                return;
            }
            
            // Create budget item object
            const budgetItem = {
                id: Date.now(), // Unique ID for the item
                name: itemName,
                category: category,
                subcategory: subcategory,
                subcategoryText: subcategoryText,
                amount: amount,
                notes: notes
            };
            
            // Add to budget items array
            budgetItems.push(budgetItem);
            
            // Update the table
            updateBudgetItemsTable();
            
            // Clear the form
            document.getElementById('item-name').value = '';
            document.getElementById('item-category').value = '';
            document.getElementById('item-subcategory').value = '';
            document.getElementById('item-subcategory').disabled = true;
            document.getElementById('item-amount').value = '';
            document.getElementById('item-notes').value = '';
            
            // Focus on item name field
            document.getElementById('item-name').focus();
        }
        
        // Function to update the budget items table
        function updateBudgetItemsTable() {
            const tableBody = document.getElementById('budget-items-table-body');
            tableBody.innerHTML = '';
            
            // Add each budget item to the table
            budgetItems.forEach(item => {
                const row = document.createElement('tr');
                
                // Create cells
                const nameCell = document.createElement('td');
                nameCell.textContent = item.name;
                
                const categoryCell = document.createElement('td');
                categoryCell.textContent = item.category === 'income' ? 'Income' : 'Expense';
                
                const subcategoryCell = document.createElement('td');
                subcategoryCell.textContent = item.subcategoryText;
                
                const amountCell = document.createElement('td');
                amountCell.textContent = formatCurrency(item.amount);
                
                const notesCell = document.createElement('td');
                notesCell.textContent = item.notes;
                
                const actionsCell = document.createElement('td');
                const removeButton = document.createElement('button');
                removeButton.textContent = 'Remove';
                removeButton.className = 'btn btn-danger btn-sm';
                removeButton.addEventListener('click', () => removeBudgetItem(item.id));
                actionsCell.appendChild(removeButton);
                
                // Add cells to row
                row.appendChild(nameCell);
                row.appendChild(categoryCell);
                row.appendChild(subcategoryCell);
                row.appendChild(amountCell);
                row.appendChild(notesCell);
                row.appendChild(actionsCell);
                
                // Add row to table
                tableBody.appendChild(row);
            });
            
            // Update totals
            updateBudgetTotals();
        }
        
        // Function to remove a budget item
        function removeBudgetItem(id) {
            budgetItems = budgetItems.filter(item => item.id !== id);
            updateBudgetItemsTable();
        }
        
        // Function to update budget totals
        function updateBudgetTotals() {
            // Calculate totals
            let totalIncome = 0;
            let totalExpenses = 0;
            
            budgetItems.forEach(item => {
                if (item.category === 'income') {
                    totalIncome += item.amount;
                } else if (item.category === 'expense') {
                    totalExpenses += item.amount;
                }
            });
            
            const netProfit = totalIncome - totalExpenses;
            
            // Update the display
            document.getElementById('total-income').textContent = formatCurrency(totalIncome);
            document.getElementById('total-expenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('net-profit').textContent = formatCurrency(netProfit);
        }
        
        // Function to format currency
        function formatCurrency(amount) {
            return '$' + amount.toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        // Function to validate student information
        function validateStudentInfo() {
            const studentName = document.getElementById('student-name').value.trim();
            const studentId = document.getElementById('student-id').value.trim();
            const startDate = document.getElementById('start-date').value;
            
            // Clear previous errors
            clearError('student-name');
            clearError('student-id');
            clearError('start-date');
            
            let isValid = true;
            
            if (!studentName) {
                isValid = false;
                showErrorAndScrollTo('student-name', 'Please enter your name.');
            }
            
            if (!studentId) {
                isValid = false;
                if (isValid) { // Only scroll to this if it's the first error
                    showErrorAndScrollTo('student-id', 'Please enter your student ID.');
                } else {
                    document.getElementById('student-id').classList.add('error-input');
                    let errorElement = document.createElement('div');
                    errorElement.id = 'student-id-error';
                    errorElement.className = 'feedback error';
                    errorElement.textContent = 'Please enter your student ID.';
                    document.getElementById('student-id').parentNode.insertBefore(errorElement, document.getElementById('student-id').nextSibling);
                }
            }
            
            if (!startDate) {
                isValid = false;
                if (isValid) { // Only scroll to this if it's the first error
                    showErrorAndScrollTo('start-date', 'Please enter a start date.');
                } else {
                    document.getElementById('start-date').classList.add('error-input');
                    let errorElement = document.createElement('div');
                    errorElement.id = 'start-date-error';
                    errorElement.className = 'feedback error';
                    errorElement.textContent = 'Please enter a start date.';
                    document.getElementById('start-date').parentNode.insertBefore(errorElement, document.getElementById('start-date').nextSibling);
                }
            }
            
            return isValid;
        }
        
        // Function to validate budget setup
        function validateBudgetSetup() {
            let isValid = true;
            const feedbackContainer = document.getElementById('budget-setup-feedback');
            feedbackContainer.className = ''; // Reset feedback
            
            // Check if at least 5 budget items have been added
            if (budgetItems.length < 5) {
                feedbackContainer.className = 'feedback warning';
                feedbackContainer.textContent = 'It is recommended to include at least 5 budget items. Consider adding more items before continuing.';
                feedbackContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Not setting isValid to false, making it a recommendation only
            }
            
            // Check if both income and expense items are included
            const hasIncome = budgetItems.some(item => item.category === 'income');
            const hasExpense = budgetItems.some(item => item.category === 'expense');
            
            if (!hasIncome || !hasExpense) {
                feedbackContainer.className = 'feedback warning';
                feedbackContainer.textContent = 'Your budget should include both income and expense items for a complete assessment.';
                feedbackContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Not setting isValid to false, making it a recommendation only
            }
            
            // Check for recommended income categories
            const recommendedIncomeCategories = ['crop-sales', 'livestock-sales'];
            const missingIncomeCategories = recommendedIncomeCategories.filter(
                category => !budgetItems.some(item => item.subcategory === category)
            );
            
            if (missingIncomeCategories.length > 0) {
                feedbackContainer.className = 'feedback info';
                feedbackContainer.textContent = `Consider including these key income sources: ${missingIncomeCategories.map(c => c.replace('-', ' ')).join(', ')}.`;
                feedbackContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Not setting isValid to false, making it a recommendation only
            }
            
            // Check for recommended expense categories
            const recommendedExpenseCategories = ['seeds-plants', 'fertiliser-chemicals', 'labour-wages'];
            const missingExpenseCategories = recommendedExpenseCategories.filter(
                category => !budgetItems.some(item => item.subcategory === category)
            );
            
            if (missingExpenseCategories.length > 0) {
                feedbackContainer.className = 'feedback info';
                feedbackContainer.textContent = `Consider including these key expense categories: ${missingExpenseCategories.map(c => c.replace('-', ' ')).join(', ')}.`;
                feedbackContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Not setting isValid to false, making it a recommendation only
            }
            
            // Minimum requirement: at least one budget item
            if (budgetItems.length === 0) {
                feedbackContainer.className = 'feedback error';
                feedbackContainer.textContent = 'You must add at least one budget item to continue.';
                feedbackContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                isValid = false;
            } else {
                // If valid, proceed to next tab and populate actuals table
                populateActualsTable();
                nextTab('track-actuals');
            }
            
            return isValid;
        }
        
        // Function to populate the actuals table
        function populateActualsTable() {
            const tableBody = document.getElementById('actuals-table-body');
            tableBody.innerHTML = '';
            
            // Add each budget item to the table
            budgetItems.forEach(item => {
                const row = document.createElement('tr');
                
                // Create cells
                const nameCell = document.createElement('td');
                nameCell.textContent = item.name;
                
                const categoryCell = document.createElement('td');
                categoryCell.textContent = item.category === 'income' ? 'Income' : 'Expense';
                
                const subcategoryCell = document.createElement('td');
                subcategoryCell.textContent = item.subcategoryText;
                
                const budgetedCell = document.createElement('td');
                budgetedCell.textContent = formatCurrency(item.amount);
                
                const actualCell = document.createElement('td');
                const actualInput = document.createElement('input');
                actualInput.type = 'number';
                actualInput.className = 'budget-cell';
                actualInput.value = item.amount; // Default to budgeted amount
                actualInput.dataset.id = item.id;
                actualInput.addEventListener('change', updateVariances);
                actualCell.appendChild(actualInput);
                
                const varianceCell = document.createElement('td');
                varianceCell.textContent = '$0.00';
                varianceCell.className = 'neutral-variance';
                
                // Add cells to row
                row.appendChild(nameCell);
                row.appendChild(categoryCell);
                row.appendChild(subcategoryCell);
                row.appendChild(budgetedCell);
                row.appendChild(actualCell);
                row.appendChild(varianceCell);
                
                // Add row to table
                tableBody.appendChild(row);
            });
            
            // Update totals and variances
            updateVariances();
        }
        
        // Function to update variances
        function updateVariances() {
            // Get all actual inputs
            const actualInputs = document.querySelectorAll('#actuals-table-body input');
            
            // Update budget items with actual values
            actualInputs.forEach(input => {
                const itemId = parseInt(input.dataset.id);
                const actualValue = parseFloat(input.value) || 0;
                
                // Find the corresponding budget item
                const item = budgetItems.find(item => item.id === itemId);
                if (item) {
                    item.actual = actualValue;
                    
                    // Calculate variance
                    const variance = item.category === 'income' 
                        ? item.actual - item.amount // For income, positive variance is good
                        : item.amount - item.actual; // For expenses, positive variance is good
                    
                    // Update variance display
                    const row = input.closest('tr');
                    const varianceCell = row.cells[5];
                    varianceCell.textContent = formatCurrency(variance);
                    
                    // Apply variance class
                    if (variance > 0) {
                        varianceCell.className = 'positive-variance';
                    } else if (variance < 0) {
                        varianceCell.className = 'negative-variance';
                    } else {
                        varianceCell.className = 'neutral-variance';
                    }
                }
            });
            
            // Calculate totals
            let totalIncomeBudgeted = 0;
            let totalIncomeActual = 0;
            let totalExpensesBudgeted = 0;
            let totalExpensesActual = 0;
            
            budgetItems.forEach(item => {
                if (item.category === 'income') {
                    totalIncomeBudgeted += item.amount;
                    totalIncomeActual += item.actual || 0;
                } else if (item.category === 'expense') {
                    totalExpensesBudgeted += item.amount;
                    totalExpensesActual += item.actual || 0;
                }
            });
            
            // Calculate net profit
            const netProfitBudgeted = totalIncomeBudgeted - totalExpensesBudgeted;
            const netProfitActual = totalIncomeActual - totalExpensesActual;
            
            // Calculate variances
            const incomeVariance = totalIncomeActual - totalIncomeBudgeted;
            const expensesVariance = totalExpensesBudgeted - totalExpensesActual;
            const netProfitVariance = netProfitActual - netProfitBudgeted;
            
            // Update the display
            document.getElementById('total-income-budgeted').textContent = formatCurrency(totalIncomeBudgeted);
            document.getElementById('total-income-actual').textContent = formatCurrency(totalIncomeActual);
            document.getElementById('total-income-variance').textContent = formatCurrency(incomeVariance);
            document.getElementById('total-income-variance').className = incomeVariance >= 0 ? 'positive-variance' : 'negative-variance';
            
            document.getElementById('total-expenses-budgeted').textContent = formatCurrency(totalExpensesBudgeted);
            document.getElementById('total-expenses-actual').textContent = formatCurrency(totalExpensesActual);
            document.getElementById('total-expenses-variance').textContent = formatCurrency(expensesVariance);
            document.getElementById('total-expenses-variance').className = expensesVariance >= 0 ? 'positive-variance' : 'negative-variance';
            
            document.getElementById('net-profit-budgeted').textContent = formatCurrency(netProfitBudgeted);
            document.getElementById('net-profit-actual').textContent = formatCurrency(netProfitActual);
            document.getElementById('net-profit-variance').textContent = formatCurrency(netProfitVariance);
            document.getElementById('net-profit-variance').className = netProfitVariance >= 0 ? 'positive-variance' : 'negative-variance';
        }
        
        // Function to validate actuals
        function validateActuals() {
            // For simplicity, we'll just check if all inputs have values
            const actualInputs = document.querySelectorAll('#actuals-table-body input');
            let isValid = true;
            let firstErrorInput = null;
            
            actualInputs.forEach(input => {
                if (!input.value || isNaN(parseFloat(input.value))) {
                    input.classList.add('error-input');
                    isValid = false;
                    
                    // Remember the first error input for scrolling
                    if (!firstErrorInput) {
                        firstErrorInput = input;
                    }
                } else {
                    input.classList.remove('error-input');
                }
            });
            
            if (!isValid) {
                const feedbackContainer = document.getElementById('track-actuals-feedback');
                feedbackContainer.className = 'feedback error';
                feedbackContainer.textContent = 'Please enter valid values for all actual figures.';
                
                // Scroll to the first error input
                if (firstErrorInput) {
                    firstErrorInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    setTimeout(() => {
                        firstErrorInput.focus();
                    }, 500);
                } else {
                    feedbackContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                
                return false;
            }
            
            // If valid, populate variance analysis options and proceed to next tab
            populateVarianceOptions();
            nextTab('variance-analysis');
            return true;
        }
        
        // Function to populate variance options
        function populateVarianceOptions() {
            // Calculate variance percentages for each item
            budgetItems.forEach(item => {
                const budgeted = item.amount;
                const actual = item.actual || 0;
                
                // Calculate variance
                let variance, variancePercent;
                if (item.category === 'income') {
                    variance = actual - budgeted;
                    variancePercent = budgeted === 0 ? 0 : (variance / budgeted) * 100;
                } else {
                    variance = budgeted - actual;
                    variancePercent = budgeted === 0 ? 0 : (variance / budgeted) * 100;
                }
                
                // Store variance info
                item.variance = variance;
                item.variancePercent = variancePercent;
                item.varianceAbs = Math.abs(variancePercent);
            });
            
            // Sort items by absolute variance percentage (largest first)
            budgetItems.sort((a, b) => b.varianceAbs - a.varianceAbs);
            
            // Populate variance selects
            const varianceSelects = [
                document.getElementById('variance-1'),
                document.getElementById('variance-2'),
                document.getElementById('variance-3')
            ];
            
            varianceSelects.forEach(select => {
                // Clear existing options
                select.innerHTML = '<option value="">-- Select Item --</option>';
                
                // Add options for each budget item
                budgetItems.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    
                    // Format the option text
                    const varianceText = item.variance >= 0 ? 'positive' : 'negative';
                    option.textContent = `${item.name} (${varianceText} variance of ${Math.abs(item.variancePercent).toFixed(1)}%)`;
                    
                    select.appendChild(option);
                });
            });
            
            // Create variance summary
            const varianceSummary = document.getElementById('variance-summary');
            
            // Calculate totals
            let totalIncomeBudgeted = 0;
            let totalIncomeActual = 0;
            let totalExpensesBudgeted = 0;
            let totalExpensesActual = 0;
            
            budgetItems.forEach(item => {
                if (item.category === 'income') {
                    totalIncomeBudgeted += item.amount;
                    totalIncomeActual += item.actual || 0;
                } else if (item.category === 'expense') {
                    totalExpensesBudgeted += item.amount;
                    totalExpensesActual += item.actual || 0;
                }
            });
            
            // Calculate net profit
            const netProfitBudgeted = totalIncomeBudgeted - totalExpensesBudgeted;
            const netProfitActual = totalIncomeActual - totalExpensesActual;
            const netProfitVariance = netProfitActual - netProfitBudgeted;
            const netProfitVariancePercent = netProfitBudgeted === 0 ? 0 : (netProfitVariance / netProfitBudgeted) * 100;
            
            // Create summary text
            let summaryText = `<p><strong>Overall Budget Performance:</strong> `;
            
            if (netProfitVariance >= 0) {
                summaryText += `The actual net profit of ${formatCurrency(netProfitActual)} is ${formatCurrency(netProfitVariance)} (${netProfitVariancePercent.toFixed(1)}%) higher than the budgeted net profit of ${formatCurrency(netProfitBudgeted)}.`;
                varianceSummary.className = 'feedback success';
            } else {
                summaryText += `The actual net profit of ${formatCurrency(netProfitActual)} is ${formatCurrency(Math.abs(netProfitVariance))} (${Math.abs(netProfitVariancePercent).toFixed(1)}%) lower than the budgeted net profit of ${formatCurrency(netProfitBudgeted)}.`;
                varianceSummary.className = 'feedback warning';
            }
            
            summaryText += `</p><p><strong>Key Variances:</strong></p><ul>`;
            
            // Add top 3 variances to summary
            for (let i = 0; i < Math.min(3, budgetItems.length); i++) {
                const item = budgetItems[i];
                const varianceDirection = item.variance >= 0 ? 'positive' : 'negative';
                const impact = (item.category === 'income' && item.variance >= 0) || 
                              (item.category === 'expense' && item.variance >= 0) ? 
                              'favourable' : 'unfavourable';
                
                summaryText += `<li><strong>${item.name}:</strong> ${varianceDirection} variance of ${Math.abs(item.variancePercent).toFixed(1)}% (${formatCurrency(Math.abs(item.variance))}), which has an ${impact} impact on the budget.</li>`;
            }
            
            summaryText += `</ul>`;
            varianceSummary.innerHTML = summaryText;
        }
        
        // Function to validate variance analysis
        function validateVarianceAnalysis() {
            let isValid = true;
            const feedbackContainer = document.getElementById('variance-analysis-feedback');
            feedbackContainer.className = ''; // Reset feedback
            
            // Clear previous errors
            clearError('variance-1');
            clearError('variance-2');
            clearError('variance-3');
            clearError('variance-1-cause');
            clearError('variance-2-cause');
            clearError('variance-3-cause');
            clearError('variance-1-explanation');
            clearError('variance-2-explanation');
            clearError('variance-3-explanation');
            clearError('overall-assessment');
            
            // Check if at least one variance item is selected and explained
            const variance1 = document.getElementById('variance-1').value;
            const cause1 = document.getElementById('variance-1-cause').value;
            const explanation1 = document.getElementById('variance-1-explanation').value;
            
            if (!variance1 || !cause1 || !explanation1) {
                isValid = false;
                if (!variance1) {
                    showErrorAndScrollTo('variance-1', 'Please select at least one significant variance.');
                } else if (!cause1) {
                    showErrorAndScrollTo('variance-1-cause', 'Please select a cause for this variance.');
                } else {
                    showErrorAndScrollTo('variance-1-explanation', 'Please provide an explanation for this variance.');
                }
            }
            
            // Check if overall assessment is provided
            const overallAssessment = document.getElementById('overall-assessment').value;
            if (!overallAssessment) {
                isValid = false;
                if (isValid) { // Only scroll to this if it's the first error
                    showErrorAndScrollTo('overall-assessment', 'Please provide an overall assessment of the budget performance.');
                } else {
                    document.getElementById('overall-assessment').classList.add('error-input');
                }
            }
            
            // Check for duplicate selections (only if multiple selections are made)
            const variance2 = document.getElementById('variance-2').value;
            const variance3 = document.getElementById('variance-3').value;
            
            if (variance1 && variance2 && variance1 === variance2) {
                isValid = false;
                showErrorAndScrollTo('variance-2', 'Please select different variances for each item.');
            }
            
            if (variance1 && variance3 && variance1 === variance3) {
                isValid = false;
                if (isValid) { // Only scroll to this if it's the first error
                    showErrorAndScrollTo('variance-3', 'Please select different variances for each item.');
                } else {
                    document.getElementById('variance-3').classList.add('error-input');
                }
            }
            
            if (variance2 && variance3 && variance2 === variance3) {
                isValid = false;
                if (isValid) { // Only scroll to this if it's the first error
                    showErrorAndScrollTo('variance-3', 'Please select different variances for each item.');
                } else {
                    document.getElementById('variance-3').classList.add('error-input');
                }
            }
            
            // If valid, update recommendation titles and proceed to next tab
            if (isValid) {
                updateRecommendationTitles();
                nextTab('adjustments');
            }
            
            return isValid;
        }
        
        // Function to update recommendation titles
        function updateRecommendationTitles() {
            // Get selected variances
            const variance1Select = document.getElementById('variance-1');
            const variance2Select = document.getElementById('variance-2');
            const variance3Select = document.getElementById('variance-3');
            
            const variance1Id = parseInt(variance1Select.value);
            const variance2Id = parseInt(variance2Select.value);
            const variance3Id = parseInt(variance3Select.value);
            
            // Find corresponding budget items
            const item1 = budgetItems.find(item => item.id === variance1Id);
            const item2 = budgetItems.find(item => item.id === variance2Id);
            const item3 = budgetItems.find(item => item.id === variance3Id);
            
            // Update recommendation titles
            if (item1) {
                const title = `Recommendation for ${item1.name}`;
                document.getElementById('recommendation-1-title').textContent = title;
            }
            
            if (item2) {
                const title = `Recommendation for ${item2.name}`;
                document.getElementById('recommendation-2-title').textContent = title;
            }
            
            if (item3) {
                const title = `Recommendation for ${item3.name}`;
                document.getElementById('recommendation-3-title').textContent = title;
            }
        }
        
        // Function to submit the assessment
        async function submitAssessment() {
            // First validate student information
            if (!validateStudentInfo()) {
                return false;
            }
            
            let isValid = true;
            
            // Check if at least one recommendation is provided
            const details1 = document.getElementById('recommendation-1-details').value;
            
            // Clear previous errors
            clearError('recommendation-1-details');
            clearError('final-report');
            
            // Validate at least one recommendation
            if (!details1) {
                isValid = false;
                showErrorAndScrollTo('recommendation-1-details', 'Please provide at least one recommendation.');
            }
            
            // Validate final report
            const finalReport = document.getElementById('final-report').value;
            if (!finalReport) {
                isValid = false;
                if (isValid) {
                    showErrorAndScrollTo('final-report', 'Please provide a final budget report.');
                } else {
                    document.getElementById('final-report').classList.add('error-input');
                }
            }
            
            if (isValid) {
                try {
                    // Get current user
                    const user = auth.currentUser;
                    
                    if (!user) {
                        throw new Error("You must be logged in to submit an assessment.");
                    }
                    
                    // Show loading state
                    const submitButton = document.querySelector('button.btn-success');
                    const originalButtonText = submitButton.textContent;
                    submitButton.disabled = true;
                    submitButton.textContent = 'Submitting...';
                    
                    // Prepare assessment data
                    const assessmentData = {
                        userId: user.uid,
                        userEmail: user.email,
                        studentName: document.getElementById('student-name').value,
                        studentId: document.getElementById('student-id').value,
                        startDate: document.getElementById('start-date').value,
                        completionDate: new Date().toISOString(),
                        unitCode: document.getElementById('unit-code').textContent,
                        unitName: document.getElementById('unit-name').textContent,
                        status: 'submitted',
                        submittedAt: new Date(),
                        budgetItems: budgetItems,
                        variances: [
                            {
                                itemId: document.getElementById('variance-1').value,
                                cause: document.getElementById('variance-1-cause').value,
                                explanation: document.getElementById('variance-1-explanation').value
                            },
                            {
                                itemId: document.getElementById('variance-2').value,
                                cause: document.getElementById('variance-2-cause').value,
                                explanation: document.getElementById('variance-2-explanation').value
                            },
                            {
                                itemId: document.getElementById('variance-3').value,
                                cause: document.getElementById('variance-3-cause').value,
                                explanation: document.getElementById('variance-3-explanation').value
                            }
                        ],
                        overallAssessment: document.getElementById('overall-assessment').value,
                        recommendations: [
                            {
                                title: document.getElementById('recommendation-1-title').textContent,
                                details: document.getElementById('recommendation-1-details').value
                            },
                            {
                                title: document.getElementById('recommendation-2-title').textContent,
                                details: document.getElementById('recommendation-2-details').value
                            },
                            {
                                title: document.getElementById('recommendation-3-title').textContent,
                                details: document.getElementById('recommendation-3-details').value
                            }
                        ],
                        finalReport: document.getElementById('final-report').value
                    };
                    
                    // Submit to Firebase
                    const docRef = await addDoc(collection(db, "assessments"), assessmentData);
                    console.log("Assessment saved with ID:", docRef.id);
                    
                    // Update success message with assessment ID
                    const feedbackContainer = document.getElementById('adjustments-feedback');
                    feedbackContainer.className = 'feedback success';
                    feedbackContainer.innerHTML = `
                        <p>Assessment completed successfully! Your responses have been submitted.</p>
                        <p>Assessment ID: ${docRef.id}</p>
                        <p>You can view your submitted assessments in your dashboard.</p>
                    `;
                    feedbackContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Set completion date
                    document.getElementById('completion-date').valueAsDate = new Date();
                    
                    // Keep submit button disabled
                    submitButton.textContent = 'Submitted';
                    
                    // Offer to go to dashboard
                    const dashboardLink = document.createElement('a');
                    dashboardLink.href = 'student-dashboard.html';
                    dashboardLink.className = 'btn';
                    dashboardLink.textContent = 'Go to Dashboard';
                    dashboardLink.style.marginLeft = '10px';
                    submitButton.parentNode.appendChild(dashboardLink);
                    
                } catch (error) {
                    console.error("Error submitting assessment:", error);
                    
                    // Show error message
                    const feedbackContainer = document.getElementById('adjustments-feedback');
                    feedbackContainer.className = 'feedback error';
                    feedbackContainer.textContent = 'Error submitting assessment: ' + error.message;
                    feedbackContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Re-enable submit button
                    const submitButton = document.querySelector('button.btn-success');
                    submitButton.disabled = false;
                    submitButton.textContent = 'Try Again';
                }
            }
            
            return isValid;
        }
        
        // Function to show error and scroll to it
        function showErrorAndScrollTo(elementId, message) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            // Create or update error message
            let errorElement = document.getElementById(`${elementId}-error`);
            
            if (!errorElement) {
                errorElement = document.createElement('div');
                errorElement.id = `${elementId}-error`;
                errorElement.className = 'feedback error';
                element.parentNode.insertBefore(errorElement, element.nextSibling);
            }
            
            errorElement.textContent = message;
            
            // Highlight the input
            element.classList.add('error-input');
            
            // Scroll to the error
            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Focus on the element
            setTimeout(() => {
                element.focus();
            }, 500);
        }

        // Function to clear error
        function clearError(elementId) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            // Remove error class
            element.classList.remove('error-input');
            
            // Remove error message if it exists
            const errorElement = document.getElementById(`${elementId}-error`);
            if (errorElement) {
                errorElement.remove();
            }
        }
        
        // Function to navigate to the next tab
        function nextTab(tabId) {
            openTab(tabId);
        }
        
        // Function to navigate to the previous tab
        function prevTab(tabId) {
            openTab(tabId);
        }
        
        // Function to open a tab
        function openTab(tabId) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // Deactivate all tab buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });
            
            // Show the selected tab content
            document.getElementById(tabId).classList.add('active');
            
            // Activate the selected tab button
            document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');
            
            // Update progress steps
            updateProgressSteps(tabId);
        }
        
        // Function to update progress steps
        function updateProgressSteps(tabId) {
            const steps = {
                'instructions': 1,
                'budget-setup': 1,
                'track-actuals': 2,
                'variance-analysis': 3,
                'adjustments': 4
            };
            
            const currentStep = steps[tabId];
            
            // Update progress steps
            document.querySelectorAll('.progress-step').forEach(step => {
                const stepNumber = parseInt(step.getAttribute('data-step'));
                
                step.classList.remove('active', 'completed');
                
                if (stepNumber < currentStep) {
                    step.classList.add('completed');
                } else if (stepNumber === currentStep) {
                    step.classList.add('active');
                }
            });
        }
        
        // Make functions available globally
        window.validateStudentInfo = validateStudentInfo;
        window.validateBudgetSetup = validateBudgetSetup;
        window.validateActuals = validateActuals;
        window.validateVarianceAnalysis = validateVarianceAnalysis;
        window.submitAssessment = submitAssessment;
        window.nextTab = nextTab;
        window.prevTab = prevTab;
        window.openTab = openTab;
        window.updateSubcategories = updateSubcategories;
        window.addBudgetItem = addBudgetItem;
        window.removeBudgetItem = removeBudgetItem;
        window.formatCurrency = formatCurrency;
        window.showErrorAndScrollTo = showErrorAndScrollTo;
        window.clearError = clearError;
    </script>
</body>
</html>