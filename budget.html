<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Simulator | Farm Budget Assessment System</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/budget.css">
</head>
<body>
    <header>
        <nav>
            <div class="container">
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="budget.html" class="active">Budget Simulator</a></li>
                    <li><a href="farm-budget-assessment.html">Assessment</a></li>
                    <li><a href="login.html">Login</a></li>
                    <li><a href="register.html">Register</a></li>
                </ul>
            </div>
        </nav>
        <div class="container">
            <h1>Farm Budget Simulator</h1>
        </div>
    </header>

    <main class="container">
        <section class="budget-form">
            <div class="form-group">
                <label for="budget-name">Budget Name:</label>
                <input type="text" id="budget-name" placeholder="Enter a name for this budget">
            </div>
            
            <div class="form-group">
                <label for="farm-type">Farm Type:</label>
                <select id="farm-type">
                    <option value="">Select Farm Type</option>
                    <option value="dairy">Dairy Farm</option>
                    <option value="crop">Crop Farm</option>
                    <option value="livestock">Livestock Farm</option>
                    <option value="mixed">Mixed Farm</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="budget-period">Budget Period:</label>
                <select id="budget-period">
                    <option value="">Select Period</option>
                    <option value="monthly">Monthly</option>
                    <option value="quarterly">Quarterly</option>
                    <option value="annual">Annual</option>
                </select>
            </div>
            
            <h2>Income Items</h2>
            <div id="income-items">
                <div class="budget-item income-item">
                    <input type="text" class="item-name" placeholder="Item name">
                    <input type="number" class="item-amount" placeholder="Amount">
                    <button type="button" class="remove-item">Remove</button>
                </div>
            </div>
            <button type="button" id="add-income">Add Income Item</button>
            
            <h2>Expense Items</h2>
            <div id="expense-items">
                <div class="budget-item expense-item">
                    <input type="text" class="item-name" placeholder="Item name">
                    <input type="number" class="item-amount" placeholder="Amount">
                    <button type="button" class="remove-item">Remove</button>
                </div>
            </div>
            <button type="button" id="add-expense">Add Expense Item</button>
            
            <div class="budget-summary">
                <div class="summary-item">
                    <span>Total Income:</span>
                    <span id="total-income">$0.00</span>
                </div>
                <div class="summary-item">
                    <span>Total Expenses:</span>
                    <span id="total-expenses">$0.00</span>
                </div>
                <div class="summary-item">
                    <span>Net Result:</span>
                    <span id="net-result">$0.00</span>
                </div>
            </div>
            
            <div class="button-group">
                <button type="button" id="save-budget">Save Budget</button>
                <button type="button" id="clear-budget">Clear Budget</button>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2023 Farm Budget Assessment System</p>
        </div>
    </footer>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDQSMOv3ZuSH-64tYZqr3MG7uO9wHrYd8c",
            authDomain: "budget-assessment-system-1d840.firebaseapp.com",
            projectId: "budget-assessment-system-1d840",
            storageBucket: "budget-assessment-system-1d840.appspot.com",
            messagingSenderId: "1039430447930",
            appId: "1:1039430447930:web:b3c3e7a3a2d1c2a2d1c2a3"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', function() {
            console.log("Budget simulator accessible without login for testing");
            
            // Initialize the budget simulator
            initializeBudgetSimulator();
        });

        function initializeBudgetSimulator() {
            // Add event listeners for budget functionality
            document.getElementById('add-income').addEventListener('click', function() {
                addBudgetItem('income-items', 'income-item');
                updateTotals();
            });
            
            document.getElementById('add-expense').addEventListener('click', function() {
                addBudgetItem('expense-items', 'expense-item');
                updateTotals();
            });
            
            document.getElementById('save-budget').addEventListener('click', saveBudget);
            document.getElementById('clear-budget').addEventListener('click', clearBudget);
            
            // Add event listeners for removing items and updating totals
            document.addEventListener('click', function(e) {
                if (e.target && e.target.classList.contains('remove-item')) {
                    e.target.parentElement.remove();
                    updateTotals();
                }
            });
            
            document.addEventListener('input', function(e) {
                if (e.target && e.target.classList.contains('item-amount')) {
                    updateTotals();
                }
            });
        }

        function addBudgetItem(containerId, itemClass) {
            const container = document.getElementById(containerId);
            const newItem = document.createElement('div');
            newItem.className = `budget-item ${itemClass}`;
            newItem.innerHTML = `
                <input type="text" class="item-name" placeholder="Item name">
                <input type="number" class="item-amount" placeholder="Amount">
                <button type="button" class="remove-item">Remove</button>
            `;
            container.appendChild(newItem);
        }

        function updateTotals() {
            // Calculate income total
            let incomeTotal = 0;
            document.querySelectorAll('.income-item .item-amount').forEach(function(item) {
                const value = parseFloat(item.value) || 0;
                incomeTotal += value;
            });
            
            // Calculate expense total
            let expenseTotal = 0;
            document.querySelectorAll('.expense-item .item-amount').forEach(function(item) {
                const value = parseFloat(item.value) || 0;
                expenseTotal += value;
            });
            
            // Calculate net result
            const netResult = incomeTotal - expenseTotal;
            
            // Update display
            document.getElementById('total-income').textContent = '$' + incomeTotal.toFixed(2);
            document.getElementById('total-expenses').textContent = '$' + expenseTotal.toFixed(2);
            document.getElementById('net-result').textContent = '$' + netResult.toFixed(2);
            
            // Add color coding for net result
            const netResultElement = document.getElementById('net-result');
            if (netResult > 0) {
                netResultElement.className = 'positive';
            } else if (netResult < 0) {
                netResultElement.className = 'negative';
            } else {
                netResultElement.className = '';
            }
        }

        function saveBudget() {
            // Get form values
            const budgetName = document.getElementById('budget-name').value;
            const farmType = document.getElementById('farm-type').value;
            const budgetPeriod = document.getElementById('budget-period').value;
            
            // Validate form
            if (!budgetName || !farmType || !budgetPeriod) {
                alert('Please fill in all required fields (Budget Name, Farm Type, Budget Period)');
                return;
            }
            
            // Collect income items
            const incomeItems = [];
            document.querySelectorAll('.income-item').forEach(function(item) {
                const name = item.querySelector('.item-name').value;
                const amount = parseFloat(item.querySelector('.item-amount').value) || 0;
                if (name && amount > 0) {
                    incomeItems.push({ name, amount });
                }
            });
            
            // Collect expense items
            const expenseItems = [];
            document.querySelectorAll('.expense-item').forEach(function(item) {
                const name = item.querySelector('.item-name').value;
                const amount = parseFloat(item.querySelector('.item-amount').value) || 0;
                if (name && amount > 0) {
                    expenseItems.push({ name, amount });
                }
            });
            
            // Calculate totals
            const totalIncome = incomeItems.reduce((sum, item) => sum + item.amount, 0);
            const totalExpenses = expenseItems.reduce((sum, item) => sum + item.amount, 0);
            const netResult = totalIncome - totalExpenses;
            
            // TESTING MODE: Just show an alert instead of saving to Firestore
            alert("Save functionality disabled in testing mode. Budget data would be saved to Firestore in production.");
            
            // Save to localStorage for testing
            const budgetData = {
                name: budgetName,
                farmType: farmType,
                period: budgetPeriod,
                items: {
                    income: incomeItems,
                    expenses: expenseItems
                },
                totalIncome: totalIncome,
                totalExpenses: totalExpenses,
                netResult: netResult,
                createdAt: new Date().toISOString()
            };
            
            localStorage.setItem('testBudget', JSON.stringify(budgetData));
            console.log("Budget saved to localStorage for testing:", budgetData);
            alert("Budget saved to localStorage for testing");
            
            // Commented out Firestore save code
            /*
            // Get current user
            const user = auth.currentUser || JSON.parse(localStorage.getItem('currentUser'));
            
            if (!user) {
                alert('You must be logged in to save a budget');
                return;
            }
            
            // Create budget object
            const budgetData = {
                userId: user.uid,
                userEmail: user.email,
                name: budgetName,
                farmType: farmType,
                period: budgetPeriod,
                items: {
                    income: incomeItems,
                    expenses: expenseItems
                },
                totalIncome: totalIncome,
                totalExpenses: totalExpenses,
                netResult: netResult,
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp()
            };
            
            // Save to Firestore
            addDoc(collection(db, "budgets"), budgetData)
                .then(() => {
                    alert('Budget saved successfully!');
                })
                .catch((error) => {
                    console.error("Error saving budget: ", error);
                    alert('Error saving budget: ' + error.message);
                });
            */
        }

        function clearBudget() {
            if (confirm('Are you sure you want to clear this budget? All data will be lost.')) {
                document.getElementById('budget-name').value = '';
                document.getElementById('farm-type').value = '';
                document.getElementById('budget-period').value = '';
                
                // Clear income items except the first one
                const incomeItems = document.getElementById('income-items');
                while (incomeItems.children.length > 1) {
                    incomeItems.removeChild(incomeItems.lastChild);
                }
                incomeItems.children[0].querySelector('.item-name').value = '';
                incomeItems.children[0].querySelector('.item-amount').value = '';
                
                // Clear expense items except the first one
                const expenseItems = document.getElementById('expense-items');
                while (expenseItems.children.length > 1) {
                    expenseItems.removeChild(expenseItems.lastChild);
                }
                expenseItems.children[0].querySelector('.item-name').value = '';
                expenseItems.children[0].querySelector('.item-amount').value = '';
                
                // Update totals
                updateTotals();
            }
        }
    </script>
</body>
</html>