<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="description" content="View Student Profile - AHCBUS408 Budget Master">
    <title>Student Profile - AHCBUS408 Budget Master</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="images/RIST Brandmark - Navy Circle.png" type="image/png">
    <style>
        .profile-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: var(--primary-navy);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            margin-right: 20px;
        }
        
        .profile-info {
            flex: 1;
        }
        
        .profile-info h2 {
            margin: 0 0 10px 0;
        }
        
        .profile-meta {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .profile-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-card .number {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary-navy);
            margin: 10px 0;
        }
        
        .stat-card .label {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        .profile-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .profile-section h3 {
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #e1e4e8;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .data-table th, .data-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e1e4e8;
        }
        
        .data-table th {
            background-color: #f1f1f1;
            font-weight: bold;
        }
        
        .data-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-submitted {
            background-color: #e1f5fe;
            color: #0288d1;
        }
        
        .status-graded {
            background-color: #e8f5e9;
            color: #388e3c;
        }
        
        .action-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        
        .action-buttons .btn {
            margin-right: 10px;
        }
        
        .empty-state {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        
        @media (max-width: 768px) {
            .profile-header {
                flex-direction: column;
                text-align: center;
            }
            
            .profile-avatar {
                margin-right: 0;
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo-container">
                    <img src="images/RIST - Primary Colour.jpg" alt="RIST - Rural Industries Skill Training" class="rist-logo">
                </div>
                <div class="title-container">
                    <h1>AHCBUS408 Budget Master</h1>
                    <p>Agricultural Budgeting Training Tool</p>
                </div>
                <div id="user-status" class="user-status">
                    <!-- Login status will be shown here -->
                </div>
            </div>
        </div>
    </header>
    <nav>
        <div class="container">
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="budget.html">Budget Simulator</a></li>
                <li><a href="farm-budget-assessment.html">Assessment</a></li>
                <li id="dashboard-nav-item"><a href="#" id="dashboard-link">Dashboard</a></li>
                <li id="logout-nav-item"><a href="#" id="logout-link">Logout</a></li>
            </ul>
        </div>
    </nav>

    <main class="container">
        <div id="loading-indicator" class="text-center">
            <p>Loading student profile...</p>
        </div>
        
        <div id="profile-container" class="profile-container" style="display: none;">
            <div class="profile-header">
                <div class="profile-avatar" id="profile-avatar">JS</div>
                <div class="profile-info">
                    <h2 id="student-name">Student Name</h2>
                    <div class="profile-meta">
                        <p id="student-email">student@example.com</p>
                        <p>Registered: <span id="registration-date">January 1, 2023</span></p>
                    </div>
                </div>
            </div>
            
            <div class="profile-stats">
                <div class="stat-card">
                    <div class="label">Assessments</div>
                    <div class="number" id="assessment-count">0</div>
                </div>
                <div class="stat-card">
                    <div class="label">Budgets Created</div>
                    <div class="number" id="budget-count">0</div>
                </div>
                <div class="stat-card">
                    <div class="label">Average Grade</div>
                    <div class="number" id="average-grade">0</div>
                </div>
                <div class="stat-card">
                    <div class="label">Last Activity</div>
                    <div class="number" id="last-activity">-</div>
                </div>
            </div>
            
            <div class="profile-section">
                <h3>Assessments</h3>
                <div id="assessments-container">
                    <p class="loading">Loading assessments...</p>
                </div>
            </div>
            
            <div class="profile-section">
                <h3>Budgets</h3>
                <div id="budgets-container">
                    <p class="loading">Loading budgets...</p>
                </div>
            </div>
            
            <div class="action-buttons">
                <div>
                    <a href="#" id="back-link" class="btn btn-secondary">Back to Dashboard</a>
                </div>
                
                <div id="trainer-actions" style="display: none;">
                    <button id="send-message" class="btn">Send Message</button>
                </div>
            </div>
        </div>
        
        <div id="error-container" class="feedback error" style="display: none;">
            <p>Error loading student profile. Please try again later.</p>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <img src="images/RIST Brandmark - Navy Circle.png" alt="RIST" class="rist-logo-footer">
                </div>
                <div class="footer-info">
                    <p>&copy; 2025 RIST - Rural Industries Skill Training</p>
                    <p>AHCBUS408 Budget Master</p>
                </div>
                <div class="footer-contact">
                    <p>Contact: <a href="mailto:info@rist.com.au">info@rist.com.au</a></p>
                </div>
            </div>
        </div>
    </footer>

    <script type="module">
        import { checkAuth } from './js/auth.js';
        import { 
            auth, 
            onAuthStateChanged, 
            signOut, 
            db, 
            doc, 
            getDoc, 
            collection, 
            query, 
            where, 
            getDocs,
            setPersistence,
            browserLocalPersistence
        } from './js/firebase-config.js';
        
        // Set persistence to LOCAL (survives browser restarts)
        setPersistence(auth, browserLocalPersistence)
          .then(() => {
            console.log("Persistence set to LOCAL");
          })
          .catch((error) => {
            console.error("Error setting persistence:", error);
          });
        
        // Global variables
        let currentUser = null;
        
        // Check authentication first
        checkAuth().then(async (isAuthenticated) => {
            if (!isAuthenticated) {
                return; // Stop execution if not authenticated
            }
            
            // Check if user is a trainer
            const user = auth.currentUser;
            if (user) {
                try {
                    const userDoc = await getDoc(doc(db, 'users', user.uid));
                    if (userDoc.exists() && userDoc.data().role !== 'trainer') {
                        // Not a trainer, redirect to student dashboard
                        alert('You do not have permission to access this page.');
                        window.location.href = 'student-dashboard.html';
                        return;
                    }
                } catch (error) {
                    console.error("Error checking user role:", error);
                    alert('Error checking permissions. Please try again later.');
                    window.location.href = 'index.html';
                    return;
                }
            }
            
            // Get student ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const studentId = urlParams.get('id');
            
            if (!studentId) {
                showError("No student ID provided. Please go back and try again.");
                return;
            }
            
            // Initialize the page
            document.addEventListener('DOMContentLoaded', function() {
                // Set up a single auth state observer
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUser = user;
                        document.getElementById('user-status').innerHTML = 'Logged in as: ' + user.email;
                        
                        // Set dashboard link
                        document.getElementById('dashboard-link').href = 'trainer-dashboard.html';
                        document.getElementById('back-link').href = 'trainer-dashboard.html';
                        document.getElementById('trainer-actions').style.display = 'block';
                        
                        // Load student profile
                        loadStudentProfile(studentId);
                    } else {
                        // Only redirect if we previously had a user and now don't
                        if (currentUser) {
                            alert("Your session has expired. Please log in again.");
                            window.location.href = 'login.html';
                        }
                    }
                });
                
                // Clean up the observer when the page is unloaded
                window.addEventListener('beforeunload', () => unsubscribe());
                
                // Logout functionality
                document.getElementById('logout-link').addEventListener('click', function(e) {
                    e.preventDefault();
                    signOut(auth).then(() => {
                        // Sign-out successful
                        window.location.href = 'login.html';
                    }).catch((error) => {
                        // An error happened
                        console.error("Error signing out:", error);
                    });
                });
                
                // Send message functionality
                document.getElementById('send-message').addEventListener('click', function() {
                    const message = prompt("Enter message to send to student:");
                    if (message) {
                        sendMessage(studentId, message);
                    }
                });
            });
        });
        
        // Load student profile
        async function loadStudentProfile(studentId) {
            try {
                // Get the student document
                const studentDoc = await getDoc(doc(db, "users", studentId));
                
                if (!studentDoc.exists()) {
                    showError("Student not found!");
                    return;
                }
                
                const student = studentDoc.data();
                
                // Display student profile
                displayStudentProfile(student, studentId);
                
                // Load student assessments
                loadStudentAssessments(studentId);
                
                // Load student budgets
                loadStudentBudgets(studentId);
                
            } catch (error) {
                console.error("Error loading student profile:", error);
                showError("Error loading student profile: " + error.message);
            }
        }
        
        // Display student profile
        function displayStudentProfile(student, studentId) {
            // Hide loading indicator
            document.getElementById('loading-indicator').style.display = 'none';
            
            // Show profile container
            document.getElementById('profile-container').style.display = 'block';
            
            // Set student info
            document.getElementById('student-name').textContent = student.fullName || 'Unknown';
            document.getElementById('student-email').textContent = student.email || 'No email provided';
            
            // Format registration date
            const registrationDate = student.createdAt ? 
                new Date(student.createdAt.seconds * 1000).toLocaleDateString() : 'Unknown';
            document.getElementById('registration-date').textContent = registrationDate;
            
            // Set avatar initials
            if (student.fullName) {
                const nameParts = student.fullName.split(' ');
                let initials = '';
                if (nameParts.length >= 2) {
                    initials = nameParts[0].charAt(0) + nameParts[1].charAt(0);
                } else {
                    initials = nameParts[0].charAt(0);
                }
                document.getElementById('profile-avatar').textContent = initials.toUpperCase();
            }
            
            // Set last activity
            const lastActivity = student.lastActivity ? 
                new Date(student.lastActivity.seconds * 1000).toLocaleDateString() : 'Never';
            document.getElementById('last-activity').textContent = lastActivity;
        }
        
        // Load student assessments
        async function loadStudentAssessments(studentId) {
            try {
                // Query for assessments by this student
                const q = query(
                    collection(db, "assessments"), 
                    where("userId", "==", studentId)
                );
                
                const querySnapshot = await getDocs(q);
                
                // Update assessment count
                document.getElementById('assessment-count').textContent = querySnapshot.size;
                
                if (querySnapshot.empty) {
                    document.getElementById('assessments-container').innerHTML = `
                        <div class="empty-state">
                            <p>No assessments found for this student.</p>
                        </div>
                    `;
                    return;
                }
                
                // Calculate average grade
                let totalGrade = 0;
                let gradedCount = 0;
                
                querySnapshot.forEach(doc => {
                    const assessment = doc.data();
                    if (assessment.grade) {
                        totalGrade += assessment.grade;
                        gradedCount++;
                    }
                });
                
                const averageGrade = gradedCount > 0 ? Math.round(totalGrade / gradedCount) : 0;
                document.getElementById('average-grade').textContent = averageGrade;
                
                // Create table of assessments
                let assessmentsTable = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Unit Code</th>
                                <th>Submitted Date</th>
                                <th>Status</th>
                                <th>Grade</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                querySnapshot.forEach((doc) => {
                    const assessment = doc.data();
                    const submittedDate = assessment.submittedAt ? 
                        new Date(assessment.submittedAt.seconds * 1000).toLocaleDateString() : 
                        'Unknown';
                    
                    assessmentsTable += `
                        <tr>
                            <td>${assessment.unitCode || 'Unknown'}</td>
                            <td>${submittedDate}</td>
                            <td>
                                <span class="status-badge status-${assessment.status || 'submitted'}">
                                    ${assessment.status ? assessment.status.charAt(0).toUpperCase() + assessment.status.slice(1) : 'Submitted'}
                                </span>
                            </td>
                            <td>${assessment.grade || 'Not graded'}</td>
                            <td>
                                <a href="view-assessment.html?id=${doc.id}" class="btn-small btn-view">View</a>
                                ${assessment.status !== 'graded' ? 
                                    `<a href="review-assessment.html?id=${doc.id}" class="btn-small btn-grade">Review</a>` : 
                                    ''}
                            </td>
                        </tr>
                    `;
                });
                
                assessmentsTable += `
                        </tbody>
                    </table>
                `;
                
                document.getElementById('assessments-container').innerHTML = assessmentsTable;
                
            } catch (error) {
                console.error("Error loading student assessments:", error);
                document.getElementById('assessments-container').innerHTML = `
                    <p class="error">Error loading assessments: ${error.message}</p>
                `;
            }
        }
        
        // Load student budgets
        async function loadStudentBudgets(studentId) {
            try {
                // Query for budgets by this student
                const q = query(
                    collection(db, "budgets"), 
                    where("userId", "==", studentId)
                );
                
                const querySnapshot = await getDocs(q);
                
                // Update budget count
                document.getElementById('budget-count').textContent = querySnapshot.size;
                
                if (querySnapshot.empty) {
                    document.getElementById('budgets-container').innerHTML = `
                        <div class="empty-state">
                            <p>No budgets found for this student.</p>
                        </div>
                    `;
                    return;
                }
                
                // Create table of budgets
                let budgetsTable = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Budget Name</th>
                                <th>Farm Type</th>
                                <th>Created Date</th>
                                <th>Net Result</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                querySnapshot.forEach((doc) => {
                    const budget = doc.data();
                    const createdDate = budget.createdAt ? 
                        new Date(budget.createdAt.seconds * 1000).toLocaleDateString() : 
                        'Unknown';
                    
                    budgetsTable += `
                        <tr>
                            <td>${budget.name || 'Untitled Budget'}</td>
                            <td>${budget.farmType || 'Unknown'}</td>
                            <td>${createdDate}</td>
                            <td>${formatCurrency(budget.netResult || 0)}</td>
                            <td>
                                <a href="view-budget.html?id=${doc.id}" class="btn-small btn-view">View</a>
                            </td>
                        </tr>
                    `;
                });
                
                budgetsTable += `
                        </tbody>
                    </table>
                `;
                
                document.getElementById('budgets-container').innerHTML = budgetsTable;
                
            } catch (error) {
                console.error("Error loading student budgets:", error);
                document.getElementById('budgets-container').innerHTML = `
                    <p class="error">Error loading budgets: ${error.message}</p>
                `;
            }
        }
        
        // Send message to student
        async function sendMessage(studentId, message) {
            try {
                // Get current user
                const user = auth.currentUser;
                if (!user) {
                    alert('You must be logged in to send messages.');
                    return;
                }
                
                // Get user role
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (!userDoc.exists() || userDoc.data().role !== 'trainer') {
                    alert('Only trainers can send messages to students.');
                    return;
                }
                
                // Add message to student's messages collection
                await addDoc(collection(db, "users", studentId, "messages"), {
                    text: message,
                    sentAt: new Date(),
                    sentBy: user.email,
                    read: false
                });
                
                alert('Message sent successfully!');
                
            } catch (error) {
                console.error("Error sending message:", error);
                alert('Error sending message: ' + error.message);
            }
        }
        
        // Format currency
        function formatCurrency(amount) {
            return '$' + Number(amount).toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        // Show error message
        function showError(message) {
            document.getElementById('loading-indicator').style.display = 'none';
            const errorContainer = document.getElementById('error-container');
            errorContainer.style.display = 'block';
            errorContainer.innerHTML = `<p>${message}</p>`;
        }
    </script>
</body>
</html>