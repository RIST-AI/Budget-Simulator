<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Review Assessment - AHCBUS408 Budget Master</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="images/RIST Brandmark - Navy Circle.png" type="image/png">
    <style>
        .review-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e1e4e8;
        }
        
        .review-title h2 {
            margin: 0;
        }
        
        .review-meta {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .review-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-submitted {
            background-color: #e1f5fe;
            color: #0288d1;
        }
        
        .status-graded {
            background-color: #e8f5e9;
            color: #388e3c;
        }
        
        .review-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .review-section h3 {
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #e1e4e8;
        }
        
        .budget-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .budget-table th,
        .budget-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e1e4e8;
        }
        
        .budget-table th {
            background-color: #f1f1f1;
        }
        
        .variance-item {
            margin-bottom: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 4px;
            border-left: 4px solid #3498db;
        }
        
        .recommendation-item {
            margin-bottom: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 4px;
            border-left: 4px solid #2ecc71;
        }
        
        .grading-form {
            background-color: #f0f7ff;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .grading-form h3 {
            margin-top: 0;
            margin-bottom: 20px;
        }
        
        .rubric-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .rubric-table th,
        .rubric-table td {
            padding: 10px;
            text-align: left;
            border: 1px solid #e1e4e8;
        }
        
        .rubric-table th {
            background-color: #f1f1f1;
        }
        
        .rubric-table td.score-cell {
            width: 100px;
        }
        
        .rubric-table input[type="number"] {
            width: 60px;
            padding: 5px;
            text-align: center;
        }
        
        .feedback-section {
            margin-top: 20px;
        }
        
        .feedback-section textarea {
            width: 100%;
            min-height: 150px;
            padding: 10px;
            border: 1px solid #e1e4e8;
            border-radius: 4px;
            resize: vertical;
        }
        
        .action-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        
        .action-buttons .btn {
            margin-right: 10px;
        }
        
        .grade-summary {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            display: flex;
            align-items: center;
        }
        
        .grade-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            font-weight: bold;
            margin-right: 20px;
        }
        
        .grade-details {
            flex: 1;
        }
        
        .annotation-toggle {
            display: inline-block;
            margin-left: 10px;
            color: #3498db;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .annotation-panel {
            display: none;
            background-color: #fff8e1;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            border-left: 4px solid #f39c12;
        }
        
        .annotation-panel.active {
            display: block;
        }
        
        .annotation-panel textarea {
            width: 100%;
            min-height: 80px;
            margin-top: 10px;
            padding: 8px;
            border: 1px solid #e1e4e8;
            border-radius: 4px;
            resize: vertical;
        }
        
        @media (max-width: 768px) {
            .review-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .review-meta {
                margin-top: 10px;
            }
            
            .grade-summary {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .grade-circle {
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo-container">
                    <img src="images/RIST - Primary Colour.jpg" alt="RIST - Rural Industries Skill Training" class="rist-logo">
                </div>
                <div class="title-container">
                    <h1>AHCBUS408 Budget Master</h1>
                    <p>Agricultural Budgeting Training Tool</p>
                </div>
                <div id="user-status" class="user-status">
                    <!-- Login status will be shown here -->
                </div>
            </div>
        </div>
    </header>
    <nav>
        <div class="container">
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="budget.html">Budget Simulator</a></li>
                <li><a href="farm-budget-assessment.html">Assessment</a></li>
                <li id="dashboard-nav-item"><a href="trainer-dashboard.html">Dashboard</a></li>
                <li id="logout-nav-item"><a href="#" id="logout-link">Logout</a></li>
            </ul>
        </div>
    </nav>

    <main class="container">
        <div id="loading-indicator" class="text-center">
            <p>Loading assessment details...</p>
        </div>
        
        <div id="review-container" class="review-container" style="display: none;">
            <div class="review-header">
                <div class="review-title">
                    <h2>Review Assessment</h2>
                    <div class="review-meta">
                        <span id="assessment-date">Submitted on: </span> | 
                        <span id="assessment-id">ID: </span>
                    </div>
                </div>
                <div>
                    <span id="assessment-status" class="review-status"></span>
                </div>
            </div>
            
            <div class="review-section">
                <h3>Student Information</h3>
                <div class="student-info-grid">
                    <div>
                        <strong>Name:</strong> <span id="student-name"></span>
                    </div>
                    <div>
                        <strong>Student ID:</strong> <span id="student-id"></span>
                    </div>
                    <div>
                        <strong>Email:</strong> <span id="student-email"></span>
                    </div>
                    <div>
                        <strong>Start Date:</strong> <span id="start-date"></span>
                    </div>
                    <div>
                        <strong>Completion Date:</strong> <span id="completion-date"></span>
                    </div>
                </div>
            </div>
            
            <div class="review-section">
                <h3>Budget Items</h3>
                <table class="budget-table" id="budget-items-table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Category</th>
                            <th>Subcategory</th>
                            <th>Budgeted</th>
                            <th>Actual</th>
                            <th>Variance</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="budget-items-body">
                        <!-- Budget items will be added here -->
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3"><strong>Total Income:</strong></td>
                            <td id="total-income-budgeted"></td>
                            <td id="total-income-actual"></td>
                            <td id="total-income-variance"></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="3"><strong>Total Expenses:</strong></td>
                            <td id="total-expenses-budgeted"></td>
                            <td id="total-expenses-actual"></td>
                            <td id="total-expenses-variance"></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="3"><strong>Net Profit/Loss:</strong></td>
                            <td id="net-profit-budgeted"></td>
                            <td id="net-profit-actual"></td>
                            <td id="net-profit-variance"></td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
                
                <div id="budget-annotation-panel" class="annotation-panel">
                    <h4>Budget Feedback</h4>
                    <p>Add your feedback about the budget structure and items:</p>
                    <textarea id="budget-annotation" placeholder="Enter your feedback about the budget items..."></textarea>
                </div>
            </div>
            
            <div class="review-section">
                <h3>Variance Analysis</h3>
                <div id="variance-items">
                    <!-- Variance items will be added here -->
                </div>
                
                <h4>Overall Budget Performance Assessment</h4>
                <div id="overall-assessment" class="overall-assessment">
                    <!-- Overall assessment will be added here -->
                </div>
                
                <div id="variance-annotation-panel" class="annotation-panel">
                    <h4>Variance Analysis Feedback</h4>
                    <p>Add your feedback about the student's variance analysis:</p>
                    <textarea id="variance-annotation" placeholder="Enter your feedback about the variance analysis..."></textarea>
                </div>
            </div>
            
            <div class="review-section">
                <h3>Recommendations</h3>
                <div id="recommendation-items">
                    <!-- Recommendation items will be added here -->
                </div>
                
                <div id="recommendations-annotation-panel" class="annotation-panel">
                    <h4>Recommendations Feedback</h4>
                    <p>Add your feedback about the student's recommendations:</p>
                    <textarea id="recommendations-annotation" placeholder="Enter your feedback about the recommendations..."></textarea>
                </div>
            </div>
            
            <div class="review-section">
                <h3>Final Report</h3>
                <div id="final-report">
                    <!-- Final report will be added here -->
                </div>
                
                <div id="report-annotation-panel" class="annotation-panel">
                    <h4>Final Report Feedback</h4>
                    <p>Add your feedback about the student's final report:</p>
                    <textarea id="report-annotation" placeholder="Enter your feedback about the final report..."></textarea>
                </div>
            </div>
            
            <div class="grading-form" id="grading-form">
                <h3>Assessment Grading</h3>
                
                <table class="rubric-table">
                    <thead>
                        <tr>
                            <th>Criteria</th>
                            <th>Description</th>
                            <th>Max Score</th>
                            <th>Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Budget Structure</td>
                            <td>Appropriate categories and items included in the budget</td>
                            <td>20</td>
                            <td class="score-cell"><input type="number" id="score-budget" min="0" max="20" value="0" class="score-input"></td>
                        </tr>
                        <tr>
                            <td>Variance Analysis</td>
                            <td>Identification and explanation of significant variances</td>
                            <td>30</td>
                            <td class="score-cell"><input type="number" id="score-variance" min="0" max="30" value="0" class="score-input"></td>
                        </tr>
                        <tr>
                            <td>Recommendations</td>
                            <td>Quality and relevance of recommendations for improvement</td>
                            <td>30</td>
                            <td class="score-cell"><input type="number" id="score-recommendations" min="0" max="30" value="0" class="score-input"></td>
                        </tr>
                        <tr>
                            <td>Final Report</td>
                            <td>Clarity, completeness, and professionalism of the final report</td>
                            <td>20</td>
                            <td class="score-cell"><input type="number" id="score-report" min="0" max="20" value="0" class="score-input"></td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="2"><strong>Total Score</strong></td>
                            <td>100</td>
                            <td id="total-score">0</td>
                        </tr>
                    </tfoot>
                </table>
                
                <div class="grade-summary">
                    <div class="grade-circle" id="grade-circle">0</div>
                    <div class="grade-details">
                        <h4>Final Grade</h4>
                        <p id="grade-description">Not yet graded</p>
                    </div>
                </div>
                
                <div class="feedback-section">
                    <h4>Overall Feedback</h4>
                    <p>Provide comprehensive feedback to the student:</p>
                    <textarea id="overall-feedback" placeholder="Enter your overall feedback for the student..."></textarea>
                </div>
            </div>
            
            <div class="action-buttons">
                <div>
                    <a href="trainer-dashboard.html" class="btn btn-secondary">Back to Dashboard</a>
                    <button id="toggle-annotations-btn" class="btn">Show Annotation Panels</button>
                </div>
                
                <div>
                    <button id="save-draft-btn" class="btn btn-secondary">Save Draft</button>
                    <button id="submit-grade-btn" class="btn btn-success">Submit Grade</button>
                </div>
            </div>
        </div>
        
        <div id="error-container" class="feedback error" style="display: none;">
            <p>Error loading assessment details. Please try again later.</p>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <img src="images/RIST Brandmark - Navy Circle.png" alt="RIST" class="rist-logo-footer">
                </div>
                <div class="footer-info">
                    <p>&copy; 2025 RIST - Rural Industries Skill Training</p>
                    <p>AHCBUS408 Budget Master</p>
                </div>
                <div class="footer-contact">
                    <p>Contact: <a href="mailto:info@rist.com.au">info@rist.com.au</a></p>
                </div>
            </div>
        </div>
    </footer>

    <script type="module">
        import { auth, onAuthStateChanged, signOut, db, doc, getDoc, updateDoc, collection, setDoc, deleteDoc } from './js/firebase-config.js';
        
        // Check authentication first using localStorage
        const storedUser = localStorage.getItem('currentUser');
        if (storedUser) {
            const user = JSON.parse(storedUser);
            document.getElementById('user-status').innerHTML = 'Logged in as: ' + user.email;
            
            // Check role for appropriate access
            const storedRole = localStorage.getItem('userRole');
            
            if (storedRole !== 'trainer') {
                // Not a trainer, redirect to student dashboard
                alert('You do not have permission to access this page.');
                window.location.href = 'student-dashboard.html';
                throw new Error('Access denied');
            }
            
            // Set dashboard link
            document.getElementById('dashboard-link').href = 'trainer-dashboard.html';
            
            // Initialize the page
            initializePage(user);
        } else {
            // If no stored user, check Firebase auth
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    document.getElementById('user-status').innerHTML = 'Logged in as: ' + user.email;
                    
                    // Store user in localStorage for persistence
                    localStorage.setItem('currentUser', JSON.stringify({
                        uid: user.uid,
                        email: user.email
                    }));
                    
                    // Check user role
                    try {
                        const userDoc = await getDoc(doc(db, 'users', user.uid));
                        if (userDoc.exists()) {
                            const role = userDoc.data().role;
                            localStorage.setItem('userRole', role);
                            
                            if (role !== 'trainer') {
                                // Not a trainer, redirect to student dashboard
                                alert('You do not have permission to access this page.');
                                window.location.href = 'student-dashboard.html';
                                return;
                            }
                        } else {
                            // Default to student if role not found
                            localStorage.setItem('userRole', 'student');
                            alert('You do not have permission to access this page.');
                            window.location.href = 'student-dashboard.html';
                            return;
                        }
                    } catch (error) {
                        console.error("Error checking user role:", error);
                        alert('Error checking permissions. Please try again later.');
                        window.location.href = 'index.html';
                        return;
                    }
                    
                    // Set dashboard link
                    document.getElementById('dashboard-link').href = 'trainer-dashboard.html';
                    
                    // Initialize the page
                    initializePage(user);
                } else {
                    // Not authenticated, redirect to login
                    window.location.href = 'login.html';
                }
            });
        }
        
        // Logout functionality
        document.getElementById('logout-link').addEventListener('click', function(e) {
            e.preventDefault();
            
            // Clear localStorage
            localStorage.removeItem('currentUser');
            localStorage.removeItem('userRole');
            
            // Also sign out from Firebase
            signOut(auth).then(() => {
                // Sign-out successful
                window.location.href = 'login.html';
            }).catch((error) => {
                // An error happened
                console.error("Error signing out:", error);
                // Still redirect to login
                window.location.href = 'login.html';
            });
        });
        
        // Initialize page function
        function initializePage(user) {
            // Get assessment ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const assessmentId = urlParams.get('id');
            
            if (!assessmentId) {
                showError("No assessment ID provided. Please go back and try again.");
                return;
            }
            
            // Load assessment data
            loadAssessment(assessmentId);
            
            // Set up toggle annotations button
            document.getElementById('toggle-annotations-btn').addEventListener('click', function() {
                const annotationPanels = document.querySelectorAll('.annotation-panel');
                const isShowing = annotationPanels[0].classList.contains('active');
                
                annotationPanels.forEach(panel => {
                    if (isShowing) {
                        panel.classList.remove('active');
                        this.textContent = 'Show Annotation Panels';
                    } else {
                        panel.classList.add('active');
                        this.textContent = 'Hide Annotation Panels';
                    }
                });
            });
            
            // Calculate total score when individual scores change
            document.querySelectorAll('.score-input').forEach(input => {
                input.addEventListener('change', calculateTotalScore);
            });
            
            // Save draft button
            document.getElementById('save-draft-btn').addEventListener('click', function() {
                saveDraft(assessmentId);
            });
            
            // Submit grade button
            document.getElementById('submit-grade-btn').addEventListener('click', function() {
                submitGrade(assessmentId);
            });
        }
        
        // Load assessment data
        async function loadAssessment(assessmentId) {
            try {
                // Get the assessment document
                const assessmentDoc = await getDoc(doc(db, "assessments", assessmentId));
                
                if (!assessmentDoc.exists()) {
                    showError("Assessment not found!");
                    return;
                }
                
                const assessment = assessmentDoc.data();
                
                // Display assessment data
                displayAssessment(assessment, assessmentId);
                
                // Check if there's a draft grading
                try {
                    const draftGradingDoc = await getDoc(doc(db, "draftGradings", assessmentId));
                    if (draftGradingDoc.exists()) {
                        loadDraftGrading(draftGradingDoc.data());
                    }
                } catch (error) {
                    console.error("Error checking for draft grading:", error);
                }
                
            } catch (error) {
                console.error("Error loading assessment:", error);
                showError("Error loading assessment: " + error.message);
            }
        }
        
        // Display assessment data
        function displayAssessment(assessment, assessmentId) {
            // Hide loading indicator
            document.getElementById('loading-indicator').style.display = 'none';
            
            // Show review container
            document.getElementById('review-container').style.display = 'block';
            
            // Set basic assessment info
            document.getElementById('assessment-id').textContent = 'ID: ' + assessmentId;
            
            // Format dates
            const submittedDate = assessment.submittedAt ? 
                new Date(assessment.submittedAt.seconds * 1000).toLocaleDateString() : 'Unknown';
            document.getElementById('assessment-date').textContent = 'Submitted on: ' + submittedDate;
            
            // Set status
            const statusElement = document.getElementById('assessment-status');
            statusElement.textContent = assessment.status ? assessment.status.charAt(0).toUpperCase() + assessment.status.slice(1) : 'Submitted';
            statusElement.className = 'review-status status-' + (assessment.status || 'submitted');
            
            // Set student info
            document.getElementById('student-name').textContent = assessment.studentName || 'Not provided';
            document.getElementById('student-id').textContent = assessment.studentId || 'Not provided';
            document.getElementById('student-email').textContent = assessment.userEmail || 'Not provided';
            document.getElementById('start-date').textContent = assessment.startDate ? new Date(assessment.startDate.seconds * 1000).toLocaleDateString() : 'Not provided';
            document.getElementById('completion-date').textContent = assessment.completionDate ? new Date(assessment.completionDate.seconds * 1000).toLocaleDateString() : 'Not provided';
            
            // Display budget items
            displayBudgetItems(assessment.budgetItems || []);
            
            // Display variance analysis
            displayVarianceAnalysis(assessment);
            
            // Display recommendations
            displayRecommendations(assessment.recommendations || []);
            
            // Display final report
            document.getElementById('final-report').innerHTML = `<p>${assessment.finalReport || 'No final report provided.'}</p>`;
            
            // If already graded, disable form and show grade
            if (assessment.status === 'graded') {
                disableGradingForm();
                
                // Set grade information
                document.getElementById('grade-circle').textContent = assessment.grade || '0';
                document.getElementById('grade-description').textContent = `Graded by ${assessment.gradedBy || 'Unknown'} on ${assessment.gradedAt ? new Date(assessment.gradedAt.seconds * 1000).toLocaleDateString() : 'Unknown'}`;
                document.getElementById('overall-feedback').value = assessment.feedback || '';
                document.getElementById('overall-feedback').disabled = true;
                
                // Set individual scores if available
                if (assessment.gradingDetails && assessment.gradingDetails.scores) {
                    const scores = assessment.gradingDetails.scores;
                    document.getElementById('score-budget').value = scores.budget || 0;
                    document.getElementById('score-variance').value = scores.variance || 0;
                    document.getElementById('score-recommendations').value = scores.recommendations || 0;
                    document.getElementById('score-report').value = scores.report || 0;
                    
                    // Update total score
                    calculateTotalScore();
                }
                
                // Set annotations if available
                if (assessment.gradingDetails && assessment.gradingDetails.annotations) {
                    const annotations = assessment.gradingDetails.annotations;
                    document.getElementById('budget-annotation').value = annotations.budget || '';
                    document.getElementById('variance-annotation').value = annotations.variance || '';
                    document.getElementById('recommendations-annotation').value = annotations.recommendations || '';
                    document.getElementById('report-annotation').value = annotations.report || '';
                }
                
                // Set grade circle color based on score
                const gradeCircle = document.getElementById('grade-circle');
                const grade = assessment.grade || 0;
                
                if (grade >= 80) {
                    gradeCircle.style.backgroundColor = '#2ecc71'; // Green for high grades
                } else if (grade >= 60) {
                    gradeCircle.style.backgroundColor = '#3498db'; // Blue for medium grades
                } else if (grade >= 40) {
                    gradeCircle.style.backgroundColor = '#f39c12'; // Orange for low grades
                } else {
                    gradeCircle.style.backgroundColor = '#e74c3c'; // Red for failing grades
                }
            }
        }
        
        // Display budget items
        function displayBudgetItems(budgetItems) {
            const tableBody = document.getElementById('budget-items-body');
            tableBody.innerHTML = '';
            
            // Calculate totals
            let totalIncomeBudgeted = 0;
            let totalIncomeActual = 0;
            let totalExpensesBudgeted = 0;
            let totalExpensesActual = 0;
            
            // Add each budget item to the table
            budgetItems.forEach((item, index) => {
                const row = document.createElement('tr');
                
                // Calculate variance
                const variance = item.category === 'income' 
                    ? (item.actual || 0) - item.amount 
                    : item.amount - (item.actual || 0);
                
                // Update totals
                if (item.category === 'income') {
                    totalIncomeBudgeted += item.amount;
                    totalIncomeActual += item.actual || 0;
                } else {
                    totalExpensesBudgeted += item.amount;
                    totalExpensesActual += item.actual || 0;
                }
                
                // Create cells
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.category === 'income' ? 'Income' : 'Expense'}</td>
                    <td>${item.subcategoryText || ''}</td>
                    <td>${formatCurrency(item.amount)}</td>
                    <td>${formatCurrency(item.actual || 0)}</td>
                    <td class="${variance >= 0 ? 'positive-variance' : 'negative-variance'}">${formatCurrency(variance)}</td>
                    <td>
                        <span class="annotation-toggle" data-item="${index}">Add Note</span>
                    </td>
                `;
                
                // Add row to table
                tableBody.appendChild(row);
            });
            
            // Add event listeners to annotation toggles
            document.querySelectorAll('.annotation-toggle').forEach(toggle => {
                toggle.addEventListener('click', function() {
                    document.getElementById('budget-annotation-panel').classList.add('active');
                    document.getElementById('toggle-annotations-btn').textContent = 'Hide Annotation Panels';
                    document.getElementById('budget-annotation').focus();
                });
            });
            
            // Calculate net profit and variances
            const netProfitBudgeted = totalIncomeBudgeted - totalExpensesBudgeted;
            const netProfitActual = totalIncomeActual - totalExpensesActual;
            const incomeVariance = totalIncomeActual - totalIncomeBudgeted;
            const expensesVariance = totalExpensesBudgeted - totalExpensesActual;
            const netProfitVariance = netProfitActual - netProfitBudgeted;
            
            // Update totals in the table footer
            document.getElementById('total-income-budgeted').textContent = formatCurrency(totalIncomeBudgeted);
            document.getElementById('total-income-actual').textContent = formatCurrency(totalIncomeActual);
            document.getElementById('total-income-variance').textContent = formatCurrency(incomeVariance);
            document.getElementById('total-income-variance').className = incomeVariance >= 0 ? 'positive-variance' : 'negative-variance';
            
            document.getElementById('total-expenses-budgeted').textContent = formatCurrency(totalExpensesBudgeted);
            document.getElementById('total-expenses-actual').textContent = formatCurrency(totalExpensesActual);
            document.getElementById('total-expenses-variance').textContent = formatCurrency(expensesVariance);
            document.getElementById('total-expenses-variance').className = expensesVariance >= 0 ? 'positive-variance' : 'negative-variance';
            
            document.getElementById('net-profit-budgeted').textContent = formatCurrency(netProfitBudgeted);
            document.getElementById('net-profit-actual').textContent = formatCurrency(netProfitActual);
            document.getElementById('net-profit-variance').textContent = formatCurrency(netProfitVariance);
            document.getElementById('net-profit-variance').className = netProfitVariance >= 0 ? 'positive-variance' : 'negative-variance';
        }
        
        // Display variance analysis
        function displayVarianceAnalysis(assessment) {
            const varianceItems = document.getElementById('variance-items');
            varianceItems.innerHTML = '';
            
            // Display variance items
            if (assessment.variances && assessment.variances.length > 0) {
                assessment.variances.forEach((variance, index) => {
                    // Find the corresponding budget item
                    const item = assessment.budgetItems.find(item => item.id == variance.itemId);
                    const itemName = item ? item.name : 'Unknown Item';
                    
                    const varianceElement = document.createElement('div');
                    varianceElement.className = 'variance-item';
                    varianceElement.innerHTML = `
                        <h4>Variance ${index + 1}: ${itemName}</h4>
                        <p><strong>Cause:</strong> ${getCauseLabel(variance.cause)}</p>
                        <p><strong>Explanation:</strong> ${variance.explanation || 'Not provided'}</p>
                        <span class="annotation-toggle" data-variance="${index}">Add Note</span>
                    `;
                    
                    varianceItems.appendChild(varianceElement);
                });
                
                // Add event listeners to annotation toggles
                document.querySelectorAll('.variance-item .annotation-toggle').forEach(toggle => {
                    toggle.addEventListener('click', function() {
                        document.getElementById('variance-annotation-panel').classList.add('active');
                        document.getElementById('toggle-annotations-btn').textContent = 'Hide Annotation Panels';
                        document.getElementById('variance-annotation').focus();
                    });
                });
            } else {
                varianceItems.innerHTML = '<p>No variance analysis provided.</p>';
            }
            
            // Display overall assessment
            document.getElementById('overall-assessment').innerHTML = `<p>${assessment.overallAssessment || 'No overall assessment provided.'}</p>`;
        }
        
        // Display recommendations
        function displayRecommendations(recommendations) {
            const recommendationItems = document.getElementById('recommendation-items');
            recommendationItems.innerHTML = '';
            
            if (recommendations && recommendations.length > 0) {
                recommendations.forEach((recommendation, index) => {
                    const recommendationElement = document.createElement('div');
                    recommendationElement.className = 'recommendation-item';
                    recommendationElement.innerHTML = `
                        <h4>${recommendation.title || `Recommendation ${index + 1}`}</h4>
                        <p>${recommendation.details || 'No details provided.'}</p>
                        <span class="annotation-toggle" data-recommendation="${index}">Add Note</span>
                    `;
                    
                    recommendationItems.appendChild(recommendationElement);
                });
                
                // Add event listeners to annotation toggles
                document.querySelectorAll('.recommendation-item .annotation-toggle').forEach(toggle => {
                    toggle.addEventListener('click', function() {
                        document.getElementById('recommendations-annotation-panel').classList.add('active');
                        document.getElementById('toggle-annotations-btn').textContent = 'Hide Annotation Panels';
                        document.getElementById('recommendations-annotation').focus();
                    });
                });
            } else {
                recommendationItems.innerHTML = '<p>No recommendations provided.</p>';
            }
        }
        
        // Calculate total score
        function calculateTotalScore() {
            const budgetScore = parseInt(document.getElementById('score-budget').value) || 0;
            const varianceScore = parseInt(document.getElementById('score-variance').value) || 0;
            const recommendationsScore = parseInt(document.getElementById('score-recommendations').value) || 0;
            const reportScore = parseInt(document.getElementById('score-report').value) || 0;
            
            const totalScore = budgetScore + varianceScore + recommendationsScore + reportScore;
            document.getElementById('total-score').textContent = totalScore;
            document.getElementById('grade-circle').textContent = totalScore;
            
            // Update grade circle color based on score
            const gradeCircle = document.getElementById('grade-circle');
            
            if (totalScore >= 80) {
                gradeCircle.style.backgroundColor = '#2ecc71'; // Green for high grades
                document.getElementById('grade-description').textContent = 'Excellent';
            } else if (totalScore >= 60) {
                gradeCircle.style.backgroundColor = '#3498db'; // Blue for medium grades
                document.getElementById('grade-description').textContent = 'Good';
            } else if (totalScore >= 40) {
                gradeCircle.style.backgroundColor = '#f39c12'; // Orange for low grades
                document.getElementById('grade-description').textContent = 'Satisfactory';
            } else {
                gradeCircle.style.backgroundColor = '#e74c3c'; // Red for failing grades
                document.getElementById('grade-description').textContent = 'Needs Improvement';
            }
        }
        
        // Save draft grading
        async function saveDraft(assessmentId) {
            try {
                // Get current user from localStorage
                const storedUser = localStorage.getItem('currentUser');
                if (!storedUser) {
                    alert('You must be logged in to save a draft.');
                    return;
                }
                
                const user = JSON.parse(storedUser);
                
                // Show loading state
                const saveButton = document.getElementById('save-draft-btn');
                const originalButtonText = saveButton.textContent;
                saveButton.disabled = true;
                saveButton.textContent = 'Saving...';
                
                // Collect grading data
                const draftData = {
                    assessmentId: assessmentId,
                    trainerId: user.uid,
                    trainerEmail: user.email,
                    savedAt: new Date(),
                    scores: {
                        budget: parseInt(document.getElementById('score-budget').value) || 0,
                        variance: parseInt(document.getElementById('score-variance').value) || 0,
                        recommendations: parseInt(document.getElementById('score-recommendations').value) || 0,
                        report: parseInt(document.getElementById('score-report').value) || 0
                    },
                    totalScore: parseInt(document.getElementById('total-score').textContent) || 0,
                    feedback: document.getElementById('overall-feedback').value,
                    annotations: {
                        budget: document.getElementById('budget-annotation').value,
                        variance: document.getElementById('variance-annotation').value,
                        recommendations: document.getElementById('recommendations-annotation').value,
                        report: document.getElementById('report-annotation').value
                    }
                };
                
                // Save to Firestore
                await setDoc(doc(db, "draftGradings", assessmentId), draftData);
                
                // Reset button and show success message
                saveButton.disabled = false;
                saveButton.textContent = originalButtonText;
                alert('Draft saved successfully!');
                
            } catch (error) {
                console.error("Error saving draft:", error);
                alert('Error saving draft: ' + error.message);
                
                // Reset button
                const saveButton = document.getElementById('save-draft-btn');
                saveButton.disabled = false;
                saveButton.textContent = 'Save Draft';
            }
        }
        
        // Submit grade
        async function submitGrade(assessmentId) {
            try {
                // Get current user from localStorage
                const storedUser = localStorage.getItem('currentUser');
                if (!storedUser) {
                    alert('You must be logged in to submit a grade.');
                    return;
                }
                
                const user = JSON.parse(storedUser);
                
                // Validate inputs
                const totalScore = parseInt(document.getElementById('total-score').textContent) || 0;
                const feedback = document.getElementById('overall-feedback').value;
                
                if (!feedback.trim()) {
                    alert('Please provide overall feedback for the student.');
                    document.getElementById('overall-feedback').focus();
                    return;
                }
                
                // Confirm submission
                if (!confirm('Are you sure you want to submit this grade? This action cannot be undone.')) {
                    return;
                }
                
                // Show loading state
                const submitButton = document.getElementById('submit-grade-btn');
                const originalButtonText = submitButton.textContent;
                submitButton.disabled = true;
                submitButton.textContent = 'Submitting...';
                
                // Update the assessment document
                await updateDoc(doc(db, "assessments", assessmentId), {
                    status: 'graded',
                    grade: totalScore,
                    feedback: feedback,
                    gradedBy: user.email,
                    gradedAt: new Date(),
                    gradingDetails: {
                        scores: {
                            budget: parseInt(document.getElementById('score-budget').value) || 0,
                            variance: parseInt(document.getElementById('score-variance').value) || 0,
                            recommendations: parseInt(document.getElementById('score-recommendations').value) || 0,
                            report: parseInt(document.getElementById('score-report').value) || 0
                        },
                        annotations: {
                            budget: document.getElementById('budget-annotation').value,
                            variance: document.getElementById('variance-annotation').value,
                            recommendations: document.getElementById('recommendations-annotation').value,
                            report: document.getElementById('report-annotation').value
                        }
                    }
                });
                
                // Delete draft grading if it exists
                try {
                    await deleteDoc(doc(db, "draftGradings", assessmentId));
                } catch (e) {
                    console.log("No draft to delete or error deleting draft:", e);
                }
                
                alert('Grade submitted successfully!');
                
                // Redirect to trainer dashboard
                window.location.href = 'trainer-dashboard.html';
                
            } catch (error) {
                console.error("Error submitting grade:", error);
                alert('Error submitting grade: ' + error.message);
                
                // Reset button
                const submitButton = document.getElementById('submit-grade-btn');
                submitButton.disabled = false;
                submitButton.textContent = originalButtonText;
            }
        }
        
        // Load draft grading
        function loadDraftGrading(draft) {
            if (!draft) return;
            
            // Load scores
            if (draft.scores) {
                document.getElementById('score-budget').value = draft.scores.budget || 0;
                document.getElementById('score-variance').value = draft.scores.variance || 0;
                document.getElementById('score-recommendations').value = draft.scores.recommendations || 0;
                document.getElementById('score-report').value = draft.scores.report || 0;
                
                // Update total score
                calculateTotalScore();
            }
            
            // Load feedback
            if (draft.feedback) {
                document.getElementById('overall-feedback').value = draft.feedback;
            }
            
            // Load annotations
            if (draft.annotations) {
                document.getElementById('budget-annotation').value = draft.annotations.budget || '';
                document.getElementById('variance-annotation').value = draft.annotations.variance || '';
                document.getElementById('recommendations-annotation').value = draft.annotations.recommendations || '';
                document.getElementById('report-annotation').value = draft.annotations.report || '';
            }
            
            // Show notification
            const savedDate = draft.savedAt ? new Date(draft.savedAt.seconds * 1000).toLocaleString() : 'Unknown';
            alert(`Draft grading loaded from ${savedDate}`);
        }
        
        // Disable grading form
        function disableGradingForm() {
            document.querySelectorAll('.score-input').forEach(input => {
                input.disabled = true;
            });
            
            document.querySelectorAll('.annotation-toggle').forEach(toggle => {
                toggle.style.display = 'none';
            });
            
            document.getElementById('save-draft-btn').style.display = 'none';
            document.getElementById('submit-grade-btn').style.display = 'none';
            document.getElementById('toggle-annotations-btn').style.display = 'none';
        }
        
        // Helper function to get cause label
        function getCauseLabel(causeValue) {
            const causes = {
                'price-change': 'Price Change',
                'volume-change': 'Volume/Quantity Change',
                'timing-difference': 'Timing Difference',
                'unexpected-event': 'Unexpected Event',
                'estimation-error': 'Estimation Error',
                'efficiency-change': 'Efficiency Change',
                'other': 'Other'
            };
            
            return causes[causeValue] || causeValue || 'Not specified';
        }
        
        // Format currency
        function formatCurrency(amount) {
            return '$' + Number(amount).toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        // Show error message
        function showError(message) {
            document.getElementById('loading-indicator').style.display = 'none';
            const errorContainer = document.getElementById('error-container');
            errorContainer.style.display = 'block';
            errorContainer.innerHTML = `<p>${message}</p>`;
        }
    </script>
</body>
</html>